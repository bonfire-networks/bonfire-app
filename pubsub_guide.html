<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.4">
    <meta name="project" content="Bonfire v1.0.0-social-rc.2.24">


    <title>Bonfire PubSub System Guide — Bonfire v1.0.0-social-rc.2.24</title>

    <link rel="stylesheet" href="dist/html-elixir-RLZO5U2C.css" />

    <script defer src="dist/sidebar_items-2D9D48B9.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-Y223O6DN.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://bonfirenetworks.org" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Bonfire" />
        </a>

      <div>
        <a href="https://bonfirenetworks.org" class="sidebar-projectName" translate="no">
Bonfire
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.0.0-social-rc.2.24
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Bonfire</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Bonfire PubSub System Guide</h1>


      <a href="https://github.com/bonfire-networks/bonfire-app/blob/main/docs/topics/PUBSUB_GUIDE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This guide explains how the Publish-Subscribe (PubSub) pattern is implemented and used throughout the Bonfire framework.</p><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Bonfire's PubSub system provides a way for different parts of the application to communicate asynchronously without direct coupling. It's built on top of Phoenix PubSub and enables real-time features like notifications, live feed updates, and presence tracking.</p><p>The PubSub pattern is fundamental to Bonfire's architecture:</p><ol><li><strong>Publishers</strong> broadcast messages to specific topics</li><li><strong>Subscribers</strong> receive messages from topics they've subscribed to</li><li>No direct dependency exists between publishers and subscribers</li></ol><h2 id="core-components" class="section-heading"><a href="#core-components" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Core Components</span></h2><h3 id="bonfire-common-pubsub" class="section-heading"><a href="#bonfire-common-pubsub" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text"><a href="./Bonfire.Common.PubSub.html"><code class="inline">Bonfire.Common.PubSub</code></a></span></h3><p>The main module that provides the PubSub functionality is located at <code class="inline">extensions/bonfire_common/lib/pubsub/pubsub.ex</code>. It offers a simplified and enhanced API on top of Phoenix's PubSub system.</p><p>Key functions:</p><ul><li><code class="inline">subscribe/2</code>: Subscribe to one or multiple topics</li><li><code class="inline">broadcast/2</code>: Broadcast messages to one or multiple topics</li><li><code class="inline">broadcast_with_telemetry/3</code>: Broadcast with OpenTelemetry tracing information</li></ul><h3 id="topics-in-bonfire" class="section-heading"><a href="#topics-in-bonfire" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Topics in Bonfire</span></h3><p>Topics in Bonfire are typically string identifiers that represent:</p><ol><li><strong>User feeds</strong>: Updates to a user's feed</li><li><strong>Threads</strong>: New replies to a conversation</li><li><strong>Presence channels</strong>: User online/offline status</li><li><strong>Notification channels</strong>: User-specific notifications</li></ol><h2 id="common-usage-patterns" class="section-heading"><a href="#common-usage-patterns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Usage Patterns</span></h2><h3 id="1-broadcasting-activities-to-feeds" class="section-heading"><a href="#1-broadcasting-activities-to-feeds" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Broadcasting Activities to Feeds</span></h3><p>In <a href="./Bonfire.Social.LivePush.html"><code class="inline">Bonfire.Social.LivePush</code></a>, PubSub is used to push new activities to user feeds:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Broadcasting a new activity to multiple feed IDs</span><span class="w">
</span><span class="nc">PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="2422545753-1">(</span><span class="n">feed_ids</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2422545753-2">{</span><span class="w">
  </span><span class="p" data-group-id="2422545753-3">{</span><span class="nc">Bonfire.Social.Feeds</span><span class="p">,</span><span class="w"> </span><span class="ss">:new_activity</span><span class="p" data-group-id="2422545753-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2422545753-4">[</span><span class="w">
    </span><span class="ss">feed_ids</span><span class="p">:</span><span class="w"> </span><span class="n">feed_ids</span><span class="p">,</span><span class="w">
    </span><span class="ss">activity</span><span class="p">:</span><span class="w"> </span><span class="n">activity</span><span class="w">
  </span><span class="p" data-group-id="2422545753-4">]</span><span class="w">
</span><span class="p" data-group-id="2422545753-2">}</span><span class="p" data-group-id="2422545753-1">)</span></code></pre><h3 id="2-broadcasting-to-thread-participants" class="section-heading"><a href="#2-broadcasting-to-thread-participants" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Broadcasting to Thread Participants</span></h3><p>When someone replies to a thread, all participants are notified:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Notifying thread participants of a new reply</span><span class="w">
</span><span class="nc">PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="2344159519-1">(</span><span class="w">
  </span><span class="n">thread_id</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2344159519-2">{</span><span class="p" data-group-id="2344159519-3">{</span><span class="nc">Bonfire.Social.Threads.LiveHandler</span><span class="p">,</span><span class="w"> </span><span class="ss">:new_reply</span><span class="p" data-group-id="2344159519-3">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2344159519-4">{</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">activity</span><span class="p" data-group-id="2344159519-4">}</span><span class="p" data-group-id="2344159519-2">}</span><span class="w">
</span><span class="p" data-group-id="2344159519-1">)</span></code></pre><h3 id="3-user-presence-tracking" class="section-heading"><a href="#3-user-presence-tracking" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. User Presence Tracking</span></h3><p><a href="./Bonfire.UI.Common.Presence.html"><code class="inline">Bonfire.UI.Common.Presence</code></a> uses Phoenix Presence built on top of PubSub to track online users:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Tracking a user&#39;s presence</span><span class="w">
</span><span class="n">track</span><span class="p" data-group-id="1417682839-1">(</span><span class="w">
  </span><span class="n">self</span><span class="p" data-group-id="1417682839-2">(</span><span class="p" data-group-id="1417682839-2">)</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;bonfire:presence&quot;</span><span class="p">,</span><span class="w">
  </span><span class="n">user_id</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="1417682839-3">%{</span><span class="w">
    </span><span class="ss">pid</span><span class="p">:</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="1417682839-4">(</span><span class="p" data-group-id="1417682839-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">joined_at</span><span class="p">:</span><span class="w"> </span><span class="nc">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="1417682839-5">(</span><span class="ss">:seconds</span><span class="p" data-group-id="1417682839-5">)</span><span class="w">
  </span><span class="p" data-group-id="1417682839-3">}</span><span class="w">
</span><span class="p" data-group-id="1417682839-1">)</span></code></pre><h3 id="4-sending-notifications" class="section-heading"><a href="#4-sending-notifications" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Sending Notifications</span></h3><p><a href="./Bonfire.UI.Common.Notifications.html"><code class="inline">Bonfire.UI.Common.Notifications</code></a> broadcasts notifications to specific users:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Broadcasting a notification to specific users</span><span class="w">
</span><span class="nc">PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="8739123296-1">(</span><span class="n">user_ids</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8739123296-2">{</span><span class="w">
  </span><span class="nc">Bonfire.UI.Common.Notifications</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="8739123296-3">%{</span><span class="w">
    </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w">
    </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w">
    </span><span class="ss">url</span><span class="p">:</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w">
    </span><span class="ss">icon</span><span class="p">:</span><span class="w"> </span><span class="n">icon</span><span class="w">
  </span><span class="p" data-group-id="8739123296-3">}</span><span class="w">
</span><span class="p" data-group-id="8739123296-2">}</span><span class="p" data-group-id="8739123296-1">)</span></code></pre><h2 id="liveview-integration" class="section-heading"><a href="#liveview-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">LiveView Integration</span></h2><p>Bonfire heavily uses Phoenix LiveView, which integrates natively with PubSub for real-time UI updates.</p><h3 id="subscribing-in-liveview-components" class="section-heading"><a href="#subscribing-in-liveview-components" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscribing in LiveView Components</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">mount</span><span class="p" data-group-id="7260241650-1">(</span><span class="c">_params</span><span class="p">,</span><span class="w"> </span><span class="c">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="7260241650-1">)</span><span class="w"> </span><span class="k" data-group-id="7260241650-2">do</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p" data-group-id="7260241650-3">(</span><span class="n">socket</span><span class="p" data-group-id="7260241650-3">)</span><span class="w"> </span><span class="k" data-group-id="7260241650-4">do</span><span class="w">
    </span><span class="c1"># Subscribe to relevant topics</span><span class="w">
    </span><span class="nc">Bonfire.Common.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="7260241650-5">(</span><span class="s">&quot;feed:</span><span class="si" data-group-id="7260241650-6">#{</span><span class="n">current_user_id</span><span class="p" data-group-id="7260241650-7">(</span><span class="n">socket</span><span class="p" data-group-id="7260241650-7">)</span><span class="si" data-group-id="7260241650-6">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="7260241650-5">)</span><span class="w">
  </span><span class="k" data-group-id="7260241650-4">end</span><span class="w">
  
  </span><span class="p" data-group-id="7260241650-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="7260241650-8">}</span><span class="w">
</span><span class="k" data-group-id="7260241650-2">end</span></code></pre><h3 id="handling-pubsub-messages-in-liveview" class="section-heading"><a href="#handling-pubsub-messages-in-liveview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Handling PubSub Messages in LiveView</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># Handling a new activity in a feed</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="7896312055-1">(</span><span class="w">
  </span><span class="p" data-group-id="7896312055-2">{</span><span class="p" data-group-id="7896312055-3">{</span><span class="nc">Bonfire.Social.Feeds</span><span class="p">,</span><span class="w"> </span><span class="ss">:new_activity</span><span class="p" data-group-id="7896312055-3">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7896312055-4">%{</span><span class="ss">activity</span><span class="p">:</span><span class="w"> </span><span class="n">activity</span><span class="p" data-group-id="7896312055-4">}</span><span class="p" data-group-id="7896312055-2">}</span><span class="p">,</span><span class="w">
  </span><span class="n">socket</span><span class="w">
</span><span class="p" data-group-id="7896312055-1">)</span><span class="w"> </span><span class="k" data-group-id="7896312055-5">do</span><span class="w">
  </span><span class="p" data-group-id="7896312055-6">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">update</span><span class="p" data-group-id="7896312055-7">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:activities</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p" data-group-id="7896312055-8">[</span><span class="n">activity</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="7896312055-8">]</span><span class="p" data-group-id="7896312055-7">)</span><span class="p" data-group-id="7896312055-6">}</span><span class="w">
</span><span class="k" data-group-id="7896312055-5">end</span></code></pre><h2 id="advanced-features" class="section-heading"><a href="#advanced-features" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Advanced Features</span></h2><h3 id="telemetry-integration" class="section-heading"><a href="#telemetry-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Telemetry Integration</span></h3><p>PubSub includes OpenTelemetry integration for performance monitoring:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Broadcasting with telemetry</span><span class="w">
</span><span class="nc">Bonfire.Common.PubSub</span><span class="o">.</span><span class="n">broadcast_with_telemetry</span><span class="p" data-group-id="5598744096-1">(</span><span class="w">
  </span><span class="n">topic</span><span class="p">,</span><span class="w">
  </span><span class="n">message</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;</span><span class="si" data-group-id="5598744096-2">#{</span><span class="n">inspect</span><span class="p" data-group-id="5598744096-3">(</span><span class="nc">MyModule</span><span class="p" data-group-id="5598744096-3">)</span><span class="si" data-group-id="5598744096-2">}</span><span class="s">.my_function/1&quot;</span><span class="w">
</span><span class="p" data-group-id="5598744096-1">)</span></code></pre><h3 id="conditional-subscription" class="section-heading"><a href="#conditional-subscription" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Conditional Subscription</span></h3><p>The framework prevents unnecessary subscriptions when LiveViews aren't connected:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Only subscribes if the socket is connected or a user is present</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">subscribe</span><span class="p" data-group-id="9236711070-1">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="9236711070-1">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="9236711070-2">(</span><span class="n">topic</span><span class="p" data-group-id="9236711070-2">)</span><span class="w"> </span><span class="k" data-group-id="9236711070-3">do</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="n">socket_connected_or_user?</span><span class="p" data-group-id="9236711070-4">(</span><span class="n">socket</span><span class="p" data-group-id="9236711070-4">)</span><span class="w"> </span><span class="k" data-group-id="9236711070-5">do</span><span class="w">
    </span><span class="n">do_subscribe</span><span class="p" data-group-id="9236711070-6">(</span><span class="n">topic</span><span class="p" data-group-id="9236711070-6">)</span><span class="w">
  </span><span class="k" data-group-id="9236711070-5">else</span><span class="w">
    </span><span class="n">debug</span><span class="p" data-group-id="9236711070-7">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LiveView is not connected so we skip subscribing to&quot;</span><span class="p" data-group-id="9236711070-7">)</span><span class="w">
  </span><span class="k" data-group-id="9236711070-5">end</span><span class="w">
</span><span class="k" data-group-id="9236711070-3">end</span></code></pre><h2 id="best-practices" class="section-heading"><a href="#best-practices" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Best Practices</span></h2><ol><li><strong>Be specific with topics</strong>: Use descriptive, hierarchical topic names</li><li><strong>Keep payloads small</strong>: Avoid sending large data structures in PubSub messages</li><li><strong>Handle disconnections</strong>: Ensure your code can handle situations where PubSub fails</li><li><strong>Use pattern matching</strong>: Handle different message types clearly with pattern matching</li><li><strong>Namespace topics</strong>: Prefix topics with module names to prevent collisions</li></ol><h2 id="common-patterns-in-bonfire" class="section-heading"><a href="#common-patterns-in-bonfire" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Patterns in Bonfire</span></h2><ol><li><strong>Feed Updates</strong>: New posts or activities appearing in user feeds</li><li><strong>Thread Updates</strong>: New replies in conversations</li><li><strong>Notifications</strong>: User-facing alerts about mentions, likes, etc.</li><li><strong>Counter Updates</strong>: Incrementing unread notification counters</li><li><strong>Presence Tracking</strong>: Monitoring online users</li></ol><h2 id="example-implementation-flow" class="section-heading"><a href="#example-implementation-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example Implementation Flow</span></h2><ol><li>A user creates a post</li><li>The post is saved in the database</li><li><a href="./Bonfire.Social.LivePush.html#push_activity/3"><code class="inline">Bonfire.Social.LivePush.push_activity/3</code></a> is called</li><li>PubSub broadcasts the new activity to relevant feed topics</li><li>LiveView components subscribed to those topics receive the message</li><li>Components update their state and re-render</li></ol><h2 id="conclusion" class="section-heading"><a href="#conclusion" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Conclusion</span></h2><p>Bonfire's PubSub system is central to its real-time capabilities. Understanding how it works will help you effectively build new features, debug existing ones, and appreciate the architecture of the framework.</p><p>When extending or modifying Bonfire, consider how PubSub can enable real-time functionality without tightly coupling your components.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="phoenix_test.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
PhoenixTest
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="settings_system.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Bonfire Settings System Documentation
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Bonfire.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.4) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
