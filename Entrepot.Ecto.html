<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="Bonfire v0.9.10-classic-beta.146">


    <title>Entrepot.Ecto — Bonfire v0.9.10-classic-beta.146</title>
    <link rel="stylesheet" href="dist/html-elixir-F2VRIOKR.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-A5B2B267.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-YIPIRHGU.js"></script>

  </head>
  <body data-type="modules" class="page-module">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://bonfirenetworks.org" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Bonfire" />
        </a>

      <div>
        <a href="https://bonfirenetworks.org" class="sidebar-projectName" translate="no">
Bonfire
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.9.10-classic-beta.146
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


        <li>
          <button id="tasks-list-tab-button" role="tab" data-type="tasks" aria-controls="tasks-tab-panel" aria-selected="false" tabindex="-1">
            <span translate="no">Mix</span> Tasks
          </button>
        </li>

    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


    <div id="tasks-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="tasks-list-tab-button" hidden>
      <ul id="tasks-full-list" class="full-list"></ul>
    </div>

</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Bonfire</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/bonfire-networks/entrepot_ecto/blob/main/lib/entrepot_ecto.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

    <span translate="no">Entrepot.Ecto</span> 
    <small class="app-vsn" translate="no">(Bonfire v0.9.10-classic-beta.146)</small>

  </h1>


    <section id="moduledoc">
<p>Ecto integration for <a href="https://github.com/bonfire-networks/entrepot">Entrepôt</a></p><p><a href="https://hex.pm/packages/entrepot_ecto"><img src="https://img.shields.io/hexpm/v/entrepot_ecto.svg" alt="hex package"/></a>
<a href="https://github.com/bonfire-networks/capsulei_ecto/actions"><img src="https://github.com/bonfire-networks/entrepot_ecto/workflows/CI/badge.svg" alt="CI status"/></a></p><p>This package adds the following two features to support the use of Entrepôt with Ecto:</p><ol><li>Custom Type</li><li>Changeset helper</li></ol><h2 id="module-entrepot-ecto-type" class="section-heading">
  <a href="#module-entrepot-ecto-type" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="./Entrepot.Ecto.Type.html"><code class="inline">Entrepot.Ecto.Type</code></a></span>
</h2>
<p>In your Ecto schema specify your file field with the following type to get serialization of uploads (<a href="./Entrepot.Locator.html"><code class="inline">Entrepot.Locator</code></a>) to maps:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Attachment</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;attachments&quot;</span><span class="w"> </span><span class="k" data-group-id="1406545790-1">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:file_data</span><span class="p">,</span><span class="w"> </span><span class="nc">Entrepot.Ecto.Type</span><span class="w">
  </span><span class="k" data-group-id="1406545790-1">end</span><span class="w">
</span><span class="k">end</span></code></pre><h2 id="module-entrepot-ecto-upload" class="section-heading">
  <a href="#module-entrepot-ecto-upload" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><code class="inline">Entrepot.Ecto.upload</code></span>
</h2>
<p>Cast params to uploaded data with <code class="inline">Entrepot.Ecto.upload</code>. In the style of Ecto.Multi, it accepts either an anonymous function or a module and function name, both with arity(2). The first argument passed will be a 2 element tuple representing the key/param pair and the second value will be the changeset.</p><p>It is expected to return either a success tuple with the <code class="inline">Locator</code> struct or the changeset. In the latter case the changeset will simply be passed on down the pipe.</p><p>Even if you want to extract some metadata and apply a validation after you store the file, then the anonymous function may be all you need:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="p" data-group-id="3596993454-1">%</span><span class="nc" data-group-id="3596993454-1">Attachment</span><span class="p" data-group-id="3596993454-1">{</span><span class="p" data-group-id="3596993454-1">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="3596993454-2">(</span><span class="p" data-group-id="3596993454-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Entrepot.Ecto</span><span class="o">.</span><span class="n">upload</span><span class="p" data-group-id="3596993454-3">(</span><span class="p" data-group-id="3596993454-4">%{</span><span class="s">&quot;file_data&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">some_upload</span><span class="p" data-group-id="3596993454-4">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3596993454-5">[</span><span class="ss">:file_data</span><span class="p" data-group-id="3596993454-5">]</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="3596993454-6">fn</span><span class="w"> </span><span class="p" data-group-id="3596993454-7">{</span><span class="c">_field</span><span class="p">,</span><span class="w"> </span><span class="n">upload</span><span class="p" data-group-id="3596993454-7">}</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="k">case</span><span class="w"> </span><span class="nc">Entrepot.Storages.Disk</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="3596993454-8">(</span><span class="n">upload</span><span class="p" data-group-id="3596993454-8">)</span><span class="w"> </span><span class="k" data-group-id="3596993454-9">do</span><span class="w">
        </span><span class="p" data-group-id="3596993454-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="3596993454-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Entrepot.Locator</span><span class="o">.</span><span class="n">new!</span><span class="p" data-group-id="3596993454-11">(</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">Entrepot.Storages.Disk</span><span class="p" data-group-id="3596993454-11">)</span><span class="w">
        </span><span class="n">error_tuple</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">add_error</span><span class="p" data-group-id="3596993454-12">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;upload just...failed&quot;</span><span class="p" data-group-id="3596993454-12">)</span><span class="w">
      </span><span class="k" data-group-id="3596993454-9">end</span><span class="w">
  </span><span class="k" data-group-id="3596993454-6">end</span><span class="p" data-group-id="3596993454-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">validate_attachment</span><span class="w">
</span></code></pre><p>However, if you want to do more complicated things with the upload before storing it (such as resizing, encrypting, etc) then creating a module is probably the way to go.</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="p" data-group-id="7200502551-1">%</span><span class="nc" data-group-id="7200502551-1">Attachment</span><span class="p" data-group-id="7200502551-1">{</span><span class="p" data-group-id="7200502551-1">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="7200502551-2">(</span><span class="p" data-group-id="7200502551-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Entrepot.Ecto</span><span class="o">.</span><span class="n">upload</span><span class="p" data-group-id="7200502551-3">(</span><span class="p" data-group-id="7200502551-4">%{</span><span class="s">&quot;file_data&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">some_upload</span><span class="p" data-group-id="7200502551-4">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7200502551-5">[</span><span class="ss">:file_data</span><span class="p" data-group-id="7200502551-5">]</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Attacher</span><span class="p">,</span><span class="w"> </span><span class="ss">:attach</span><span class="p" data-group-id="7200502551-3">)</span></code></pre><hr class="thin"/><h2 id="module-upload-cleanup" class="section-heading">
  <a href="#module-upload-cleanup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Upload cleanup</span>
</h2>
<p>Since the file is written to disk as part of the changeset, you will probably want to do some cleanup depending on the error status. On success you may want to move the file from a temporary location to permanent storage (especially if the latter is in the cloud and costs a network request). On failure you may want to delete the file (unless you are handling that with some sort of periodic task).</p><p>One good option is to wrap your Repo operation in another function to handle both as asynchronous Tasks so they don't block the parent process:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_attachment</span><span class="p" data-group-id="7955456655-1">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="7955456655-1">)</span><span class="w"> </span><span class="k" data-group-id="7955456655-2">do</span><span class="w">
  </span><span class="p" data-group-id="7955456655-3">%</span><span class="nc" data-group-id="7955456655-3">Attachment</span><span class="p" data-group-id="7955456655-3">{</span><span class="p" data-group-id="7955456655-3">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">change</span><span class="p" data-group-id="7955456655-4">(</span><span class="p" data-group-id="7955456655-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Entrepot.Ecto</span><span class="o">.</span><span class="n">upload</span><span class="p" data-group-id="7955456655-5">(</span><span class="n">attrs</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7955456655-6">[</span><span class="ss">:file_data</span><span class="p" data-group-id="7955456655-6">]</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Attacher</span><span class="p">,</span><span class="w"> </span><span class="ss">:attach</span><span class="p" data-group-id="7955456655-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="7955456655-7">(</span><span class="p" data-group-id="7955456655-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="k" data-group-id="7955456655-8">do</span><span class="w">
    </span><span class="p" data-group-id="7955456655-9">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">attachment</span><span class="p" data-group-id="7955456655-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">success_tuple</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Task.Supervisor</span><span class="o">.</span><span class="n">start_child</span><span class="p" data-group-id="7955456655-10">(</span><span class="w">
        </span><span class="nc">YourApp.Supervisor</span><span class="p">,</span><span class="w">
        </span><span class="k" data-group-id="7955456655-11">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Attachment</span><span class="o">.</span><span class="n">promote_upload</span><span class="p" data-group-id="7955456655-12">(</span><span class="n">attachment</span><span class="p" data-group-id="7955456655-12">)</span><span class="w"> </span><span class="k" data-group-id="7955456655-11">end</span><span class="w">
      </span><span class="p" data-group-id="7955456655-10">)</span><span class="w">

      </span><span class="n">success_tuple</span><span class="w">

    </span><span class="p" data-group-id="7955456655-13">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7955456655-14">%{</span><span class="ss">changes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7955456655-15">%{</span><span class="ss">file_data</span><span class="p">:</span><span class="w"> </span><span class="n">file_data</span><span class="p" data-group-id="7955456655-15">}</span><span class="p" data-group-id="7955456655-14">}</span><span class="p" data-group-id="7955456655-13">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error_tuple</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Task.Supervisor</span><span class="o">.</span><span class="n">start_child</span><span class="p" data-group-id="7955456655-16">(</span><span class="w">
        </span><span class="nc">YourApp.Supervisor</span><span class="p">,</span><span class="w">
        </span><span class="k" data-group-id="7955456655-17">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Disk</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="7955456655-18">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="7955456655-18">)</span><span class="w"> </span><span class="k" data-group-id="7955456655-17">end</span><span class="w">
      </span><span class="p" data-group-id="7955456655-16">)</span><span class="w">

      </span><span class="n">error_tuple</span><span class="w">
  </span><span class="k" data-group-id="7955456655-8">end</span></code></pre><p>In this example, <code class="inline">Attachment.promote_upload(attachment)</code> would handle moving the file and updating the file data in the db. It uses <code class="inline">Multi</code> to ensure all operations succeed or fail together:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">promote_upload</span><span class="p" data-group-id="4926053039-1">(</span><span class="n">attachment</span><span class="p" data-group-id="4926053039-1">)</span><span class="w"> </span><span class="k" data-group-id="4926053039-2">do</span><span class="w">
    </span><span class="nc">Multi</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="4926053039-3">(</span><span class="p" data-group-id="4926053039-3">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="4926053039-4">(</span><span class="ss">:copy_file</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4926053039-5">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">NetworkStorage</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="4926053039-6">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">file_data</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="4926053039-6">)</span><span class="w">
    </span><span class="k" data-group-id="4926053039-5">end</span><span class="p" data-group-id="4926053039-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="4926053039-7">(</span><span class="ss">:updated_schema</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4926053039-8">fn</span><span class="w"> </span><span class="p" data-group-id="4926053039-9">%{</span><span class="ss">move_file</span><span class="p">:</span><span class="w"> </span><span class="n">new_data</span><span class="p" data-group-id="4926053039-9">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Attachment</span><span class="o">.</span><span class="n">changeset</span><span class="p" data-group-id="4926053039-10">(</span><span class="n">attachment</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4926053039-11">%{</span><span class="ss">file_data</span><span class="p">:</span><span class="w"> </span><span class="n">new_data</span><span class="w"> </span><span class="p" data-group-id="4926053039-11">}</span><span class="p" data-group-id="4926053039-10">)</span><span class="w">
    </span><span class="k" data-group-id="4926053039-8">end</span><span class="p" data-group-id="4926053039-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="4926053039-12">(</span><span class="ss">:delete_old_file</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4926053039-13">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Disk</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="4926053039-14">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">file_data</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="4926053039-14">)</span><span class="w">
    </span><span class="k" data-group-id="4926053039-13">end</span><span class="p" data-group-id="4926053039-12">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p" data-group-id="4926053039-15">(</span><span class="p" data-group-id="4926053039-15">)</span><span class="w">
  </span><span class="k" data-group-id="4926053039-2">end</span></code></pre><h2 id="module-testing" class="section-heading">
  <a href="#module-testing" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Testing</span>
</h2>
<p>Since Locators are serialized as plain maps, it is easy to stub out file operations in fixtures/factories by inserting data directly into the db without going through a changeset:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="p" data-group-id="7763688425-1">%</span><span class="nc" data-group-id="7763688425-1">Attachment</span><span class="p" data-group-id="7763688425-1">{</span><span class="w">
    </span><span class="ss">file_data</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7763688425-2">%{</span><span class="w">
      </span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fake.jpg&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7763688425-3">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fake&quot;</span><span class="p" data-group-id="7763688425-3">}</span><span class="p">,</span><span class="w"> </span><span class="ss">size</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w">
    </span><span class="p" data-group-id="7763688425-2">}</span><span class="w">
  </span><span class="p" data-group-id="7763688425-1">}</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="7763688425-4">(</span><span class="p" data-group-id="7763688425-4">)</span></code></pre><p>If you want to run tests on the actual file operations, you will need to make sure the id points to an actual file location that the configured storage understands.</p><p>You can configure your test environment to use the RAM storage:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="p" data-group-id="1933022598-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="1933022598-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Entrepot.Storages.RAM</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="1933022598-2">(</span><span class="n">some_upload</span><span class="p" data-group-id="1933022598-2">)</span><span class="w">

  </span><span class="nc">Repo</span><span class="o">.</span><span class="n">insert!</span><span class="p" data-group-id="1933022598-3">(</span><span class="p" data-group-id="1933022598-4">%</span><span class="nc" data-group-id="1933022598-4">Attachment</span><span class="p" data-group-id="1933022598-4">{</span><span class="ss">file_data</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1933022598-5">%{</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">Entrepot.Storages.RAM</span><span class="p" data-group-id="1933022598-5">}</span><span class="p" data-group-id="1933022598-4">}</span><span class="p" data-group-id="1933022598-3">)</span></code></pre><p>Or, for maximum performance, you can a simple struct that implements the <code class="inline">Upload</code> protocol:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Entrepot.MockUpload</span><span class="w"> </span><span class="k" data-group-id="5710440261-1">do</span><span class="w">
    </span><span class="kd">defstruct</span><span class="w"> </span><span class="ss">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Hi, I&#39;m a file&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hi&quot;</span><span class="w">

    </span><span class="kd">defimpl</span><span class="w"> </span><span class="nc">Entrepot.Upload</span><span class="w"> </span><span class="k" data-group-id="5710440261-2">do</span><span class="w">
      </span><span class="kd">def</span><span class="w"> </span><span class="nf">contents</span><span class="p" data-group-id="5710440261-3">(</span><span class="n">mock</span><span class="p" data-group-id="5710440261-3">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5710440261-4">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">mock</span><span class="o">.</span><span class="n">content</span><span class="p" data-group-id="5710440261-4">}</span><span class="w">

      </span><span class="kd">def</span><span class="w"> </span><span class="nf">name</span><span class="p" data-group-id="5710440261-5">(</span><span class="n">mock</span><span class="p" data-group-id="5710440261-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">mock</span><span class="o">.</span><span class="n">name</span><span class="w">
    </span><span class="k" data-group-id="5710440261-2">end</span><span class="w">
  </span><span class="k" data-group-id="5710440261-1">end</span></code></pre>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#upload/4" data-no-tooltip translate="no">upload(changeset, params, permitted, fun)</a>

      </div>

        <div class="summary-synopsis"><p>Uploads data with <a href="./Entrepot.html"><code class="inline">Entrepot</code></a> using a function.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#upload/5" data-no-tooltip translate="no">upload(changeset, params, permitted, module, func_name)</a>

      </div>

        <div class="summary-synopsis"><p>Uploads data with <a href="./Entrepot.html"><code class="inline">Entrepot</code></a> using a module and function name.</p></div>

    </div>

</div>

  </section>


  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>
    <div class="functions-list">
<section class="detail" id="upload/4">

  <div class="detail-header">
    <a href="#upload/4" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">upload(changeset, params, permitted, fun)</h1>

      <a href="https://github.com/bonfire-networks/entrepot_ecto/blob/main/lib/entrepot_ecto.ex#L21" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">

<p>Uploads data with <a href="./Entrepot.html"><code class="inline">Entrepot</code></a> using a function.</p><h2 id="upload/4-parameters" class="section-heading">
  <a href="#upload/4-parameters" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Parameters</span>
</h2>
<ul><li><code class="inline">changeset</code>: The changeset to update.</li><li><code class="inline">params</code>: Parameters to upload.</li><li><code class="inline">permitted</code>: List of permitted fields.</li><li><code class="inline">function</code>: A function with arity 2 that handles the upload.</li></ul><h2 id="upload/4-examples" class="section-heading">
  <a href="#upload/4-examples" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Examples</span>
</h2>
<pre><code class="makeup elixir" translate="no"><span class="gp unselectable">iex&gt; </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7598836048-1">%</span><span class="nc" data-group-id="7598836048-1">Ecto.Changeset</span><span class="p" data-group-id="7598836048-1">{</span><span class="p" data-group-id="7598836048-1">}</span><span class="w">
</span><span class="gp unselectable">iex&gt; </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="7598836048-2">fn</span><span class="w"> </span><span class="p" data-group-id="7598836048-3">(</span><span class="c">_params</span><span class="p">,</span><span class="w"> </span><span class="c">_changeset</span><span class="p" data-group-id="7598836048-3">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7598836048-4">%</span><span class="nc" data-group-id="7598836048-4">Entrepot.Locator</span><span class="p" data-group-id="7598836048-4">{</span><span class="p" data-group-id="7598836048-4">}</span><span class="w"> </span><span class="k" data-group-id="7598836048-2">end</span><span class="w">
</span><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot.Ecto</span><span class="o">.</span><span class="n">upload</span><span class="p" data-group-id="7598836048-5">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7598836048-6">%{</span><span class="s">&quot;field&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="7598836048-6">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7598836048-7">[</span><span class="s">&quot;field&quot;</span><span class="p" data-group-id="7598836048-7">]</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="p" data-group-id="7598836048-5">)</span><span class="w">
</span><span class="p" data-group-id="7598836048-8">%</span><span class="nc" data-group-id="7598836048-8">Ecto.Changeset</span><span class="p" data-group-id="7598836048-8">{</span><span class="p" data-group-id="7598836048-8">}</span></code></pre>
  </section>
</section>
<section class="detail" id="upload/5">

  <div class="detail-header">
    <a href="#upload/5" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">upload(changeset, params, permitted, module, func_name)</h1>

      <a href="https://github.com/bonfire-networks/entrepot_ecto/blob/main/lib/entrepot_ecto.ex#L47" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">

<p>Uploads data with <a href="./Entrepot.html"><code class="inline">Entrepot</code></a> using a module and function name.</p><h2 id="upload/5-parameters" class="section-heading">
  <a href="#upload/5-parameters" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Parameters</span>
</h2>
<ul><li><code class="inline">changeset</code>: The changeset to update.</li><li><code class="inline">params</code>: Parameters to upload.</li><li><code class="inline">permitted</code>: List of permitted fields.</li><li><code class="inline">module</code>: The module containing the function.</li><li><code class="inline">function</code>: The function name within the module.</li></ul><h2 id="upload/5-examples" class="section-heading">
  <a href="#upload/5-examples" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Examples</span>
</h2>
<pre><code class="makeup elixir" translate="no"><span class="gp unselectable">iex&gt; </span><span class="n">changeset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6754131587-1">%</span><span class="nc" data-group-id="6754131587-1">Ecto.Changeset</span><span class="p" data-group-id="6754131587-1">{</span><span class="p" data-group-id="6754131587-1">}</span><span class="w">
</span><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot.Ecto</span><span class="o">.</span><span class="n">upload</span><span class="p" data-group-id="6754131587-2">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6754131587-3">%{</span><span class="s">&quot;field&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="6754131587-3">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6754131587-4">[</span><span class="s">&quot;field&quot;</span><span class="p" data-group-id="6754131587-4">]</span><span class="p">,</span><span class="w"> </span><span class="nc">SomeModule</span><span class="p">,</span><span class="w"> </span><span class="ss">:some_function</span><span class="p" data-group-id="6754131587-2">)</span><span class="w">
</span><span class="p" data-group-id="6754131587-5">%</span><span class="nc" data-group-id="6754131587-5">Ecto.Changeset</span><span class="p" data-group-id="6754131587-5">{</span><span class="p" data-group-id="6754131587-5">}</span></code></pre>
  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Bonfire.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
