name: Maybe generate docs
on:
  push:
  # workflow_run:
  #   workflows: ["Test"]
  #   types:
  #     - completed
  #   branches:
  #     - main

jobs:
  # check_test_success:
  #   runs-on: ubuntu-latest
  #   if: ${{ github.event.workflow_run.conclusion == 'success' }}
  #   outputs:
  #     should_generate_docs: true
  #   steps:
  #     - name: Check test workflow success
  #       run: echo "Tests passed successfully, proceeding with docs generation..."
  check_file_changed:
    uses: ./.github/workflows/check_file_changed.yaml
    with:
      file: mix.lock

  check_version_changed:
    uses: ./.github/workflows/check_version_changed.yaml

  docs:
    needs: [check_file_changed, check_version_changed] #Â check_test_success
    if: ${{ needs.check_file_changed.outputs.changed == 'true' || needs.check_version_changed.outputs.version_changed == 'true' }}
    # if: ${{ needs.check_test_success.outputs.should_generate_docs == 'true' }}
    name: Generate changelog (if lockfile changed) and docs (upon new release)
    runs-on: ubuntu-latest
    container: hexpm/elixir:1.18.3-erlang-27.3.4-alpine-3.21.3
    # TODO: compute this ^ from .tool-versions
    env:
      FLAVOUR: social
      # FLAVOUR: cooperation
      MIX_ENV: dev
      COMPILE_DISABLED_EXTENSIONS: all
      WITH_DOCKER: no
      CI: true
      WITH_IMAGE_VIX: "0"
      WITH_AI: "0"
      EXQLITE_USE_SYSTEM: 1
      EXQLITE_SYSTEM_CFLAGS: -I/usr/include
      EXQLITE_SYSTEM_LDFLAGS: -L/lib -lsqlite3
    steps:
      - name: Install bash (needed for just), git (needed for checkout), tar (needed for cache), file (needed for bonfire_files), make/build-base/sqlite/graphviz (for arch), just, and curl
        run: apk add bash git tar file make build-base sqlite graphviz just curl
      - name: Install GitHub CLI
        run: |
          GH_VERSION=$(curl -s https://api.github.com/repos/cli/cli/releases/latest | grep tag_name | cut -d '"' -f4 | sed 's/^v//')
          curl -fsSL https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz | tar -xz
          mv gh_${GH_VERSION}_linux_amd64/bin/gh /usr/local/bin/
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2 # needed for action-detect-and-tag-new-version
      - name: Trust my repo
        run: export GIT_CEILING_DIRECTORIES=/__w && git config --global --add safe.directory /__w/bonfire-app/bonfire-app
      - name: Install system deps & tools
        run: |
          chmod +x deps-alpine-build.sh && ./deps-alpine-build.sh
      - name: Install hex
        run: mix local.hex --force
      - name: Install rebar
        run: mix local.rebar --force
      - name: Configure Git authentication for GitHub
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Prepare environment
        run: just config
      - name: Prepare deps
        run: just pre-setup-dev && just _flavour_install ${{ env.FLAVOUR }} --yes && just _deps-post-get
      # - name: Install dependencies
      #   run: just mix deps.get
      - name: Generate changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: just mix changelog
      - name: Create Pull Request for changelog
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "changelog [skip ci]"
          branch: changelog/update-${{ github.run_id }}
          title: "Automated changelog update"
          body: "This PR was created automatically by the workflow."
          base: main
          add-paths: docs/CHANGELOG-autogenerated.md
      - name: Enable auto-merge for PR
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
      - name: Cancel workflow if the version has not changed
        if: needs.check_version_changed.outputs.version_changed == 'false' 
        uses: andymckay/cancel-action@0.2
      - name: Generate docs
        run: just docs
      # - 
      #   name: Generate arch reports
      #   run: just arch && mv reports/dev/static/html ./docs/exdoc/arch
      - 
        name: Add version number
        run: |
          echo "${{ steps.version.outputs.current-version }}" > ./docs/exdoc/VERSION
      - name: Deploy docs
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/exdoc
          cname: docs.bonfirenetworks.org
      - 
        name: Tag/release new version
        id: version
        uses: salsify/action-detect-and-tag-new-version@v2
        with:
          create-tag: true 
          version-command: grep -m 1 'version:' mix.exs | cut -d '"' -f2
  #     - name: Create tags in extensions repos
  #       uses: bonfire-networks/create-tags-multirepo@v0.6
  #       with:
  #         version: ${{ steps.version.outputs.current-version }}
  #         message: ${{ github.event.inputs.message }}
  #         token: ${{ secrets.GH_PAT_TOKEN }}
  #         owner: "bonfire-networks"
  #         repos: "bonfire_api_graphql,bonfire_data_identity,bonfire_fail,bonfire_ui_me,bonfire_boundaries,bonfire_data_shared_user,bonfire_federate_activitypub,bonfire_quantify,bonfire_breadpub,bonfire_data_social,bonfire_files,bonfire_recyclapp,bonfire_ui_social,bonfire_classify,bonfire_geolocate,bonfire_search,bonfire_ui_valueflows,bonfire_common,bonfire_ecto,bonfire_invite_links,bonfire_social,bonfire_data_access_control,bonfire_editor_ck,bonfire_livebook,bonfire_tag,bonfire_valueflows,bonfire_data_activity_pub,bonfire_editor_quill,bonfire_mailer,bonfire_valueflows_api_schema,bonfire_data_assort,bonfire_me,bonfire_ui_common,bonfire_valueflows_observe,bonfire_epics,bonfire_notify,bonfire_ui_coordination,bonfire_data_edges,bonfire_extension_template,bonfire_open_id,bonfire_ui_kanban"
  #         # bonfire_upcycle,bonfire_publisher_thesis,bonfire_ui_reflow,bonfire_data_tasks,bonfire_taxonomy_seeder,bonfire_encryption_backend,bonfire_pages,bonfire_web_phoenix,bonfire_website
