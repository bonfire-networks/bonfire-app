<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.4">
    <meta name="project" content="Bonfire v1.0.0-social-rc.2.26">


    <title>Entrepot — Bonfire v1.0.0-social-rc.2.26</title>

    <link rel="stylesheet" href="dist/html-elixir-RLZO5U2C.css" />

    <script defer src="dist/sidebar_items-A59659D0.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-Y223O6DN.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://bonfirenetworks.org" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Bonfire" />
        </a>

      <div>
        <a href="https://bonfirenetworks.org" class="sidebar-projectName" translate="no">
Bonfire
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.0.0-social-rc.2.26
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Bonfire</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Entrepot</span> 
      <small class="app-vsn" translate="no">(Bonfire v1.0.0-social-rc.2.26)</small>

    </h1>

      <a href="https://github.com/bonfire-networks/entrepot/blob/main/lib/entrepot.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<p>Minimal, composable file upload, storage, and streamed data migrations for Elixir apps, flexibly and with minimal dependencies.</p><p><a href="https://hex.pm/packages/entrepot"><img src="https://img.shields.io/hexpm/v/entrepot.svg" alt="hex package"/></a>
<a href="https://github.com/bonfire-networks/entrepot/actions"><img src="https://github.com/bonfire-networks/entrepot/workflows/CI/badge.svg" alt="CI status"/></a></p><p>:warning: Although it's been used in production for over a year without issue, Entrepôt is experimental and still in active development. Accepting file uploads introduces specific security vulnerabilities. Use at your own risk.</p><h2 id="module-concepts" class="section-heading"><a href="#module-concepts" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Concepts</span></h2><p>Entrepôt intentionally strips file storage logic down to its most composable parts and lets you decide how you want to use them. These components are: <a href="#storage">storage</a>, <a href="#upload">upload</a>, <a href="#locator">locator</a>, and optionally, <a href="#uploader">uploader</a>, which provides a more ergonomic API for the other 3.</p><p>It is intentionally agnostic about versions, transformation, validations, etc. Most of the convenience offered by other libraries around these features comes at the cost of locking in dependence on specific tools and hiding complexity. Entrepôt puts a premium on simplicity and explicitness.</p><p>So what does it do? Here's a theoretical example of a use case with an Ecto&lt;sup&gt;1&lt;/sup&gt; schema, which stores the file retrieved from a URL, along with some additional metadata:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_attachment</span><span class="p" data-group-id="7598116910-1">(</span><span class="n">upload</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="7598116910-1">)</span><span class="w"> </span><span class="k" data-group-id="7598116910-2">do</span><span class="w">
    </span><span class="nc">Multi</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="7598116910-3">(</span><span class="p" data-group-id="7598116910-3">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="7598116910-4">(</span><span class="ss">:upload</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="7598116910-5">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">YourStorage</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="7598116910-6">(</span><span class="n">upload</span><span class="p">,</span><span class="w"> </span><span class="ss">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">:crypto</span><span class="o">.</span><span class="n">hash</span><span class="p" data-group-id="7598116910-7">(</span><span class="ss">:md5</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7598116910-8">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p" data-group-id="7598116910-8">]</span><span class="p" data-group-id="7598116910-7">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Base</span><span class="o">.</span><span class="n">encode16</span><span class="p" data-group-id="7598116910-9">(</span><span class="p" data-group-id="7598116910-9">)</span><span class="p" data-group-id="7598116910-6">)</span><span class="w">
    </span><span class="k" data-group-id="7598116910-5">end</span><span class="p" data-group-id="7598116910-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Multi</span><span class="o">.</span><span class="n">insert</span><span class="p" data-group-id="7598116910-10">(</span><span class="ss">:attachment</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="7598116910-11">fn</span><span class="w"> </span><span class="p" data-group-id="7598116910-12">%{</span><span class="ss">upload</span><span class="p">:</span><span class="w"> </span><span class="n">file_id</span><span class="p" data-group-id="7598116910-12">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="7598116910-13">%</span><span class="nc" data-group-id="7598116910-13">Attachment</span><span class="p" data-group-id="7598116910-13">{</span><span class="ss">file_data</span><span class="p">:</span><span class="w"> </span><span class="nc">Locator</span><span class="o">.</span><span class="n">new!</span><span class="p" data-group-id="7598116910-14">(</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">YourStorage</span><span class="p">,</span><span class="w"> </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7598116910-15">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;document&quot;</span><span class="p" data-group-id="7598116910-15">}</span><span class="p" data-group-id="7598116910-14">)</span><span class="w">
    </span><span class="k">end</span><span class="p">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Repo</span><span class="o">.</span><span class="n">transaction</span><span class="p" data-group-id="7598116910-16">(</span><span class="p" data-group-id="7598116910-16">)</span><span class="w">
  </span><span class="k">end</span></code></pre><p>Then to access the file:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5575698760-1">%</span><span class="nc" data-group-id="5575698760-1">Attachment</span><span class="p" data-group-id="5575698760-1">{</span><span class="ss">file_data</span><span class="p">:</span><span class="w"> </span><span class="n">file</span><span class="p" data-group-id="5575698760-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attachment</span><span class="w">

</span><span class="p" data-group-id="5575698760-2">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">contents</span><span class="p" data-group-id="5575698760-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Disk</span><span class="o">.</span><span class="n">read</span><span class="p" data-group-id="5575698760-3">(</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="5575698760-3">)</span></code></pre><sup>1</sup><h3 id="module-storage" class="section-heading"><a href="#module-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Storage</span></h3><p>A &quot;storage&quot; is a <a href="https://elixirschool.com/en/lessons/advanced/behaviours/">behaviour</a> that implements the following &quot;file-like&quot; callbacks:</p><ul><li>read</li><li>put</li><li>delete</li></ul><p>Implementing your own storage is as easy as creating a module that quacks this way. Each callback should accept an optional list of options as the last arg. Which options are supported is up to the module that implements the callbacks.</p><h3 id="module-upload" class="section-heading"><a href="#module-upload" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upload</span></h3><p>Upload is a <a href="https://elixir-lang.org/getting-started/protocols.html">protocol</a> consisting of the following two functions:</p><ul><li>contents</li><li>name</li></ul><p>A storage uses this interface to figure how to extract the file data from a given struct and how to identify it. See <a href="./Entrepot.Locator.html"><code class="inline">Entrepot.Locator</code></a> for an example of how this protocol can be implemented.</p><h3 id="module-locator" class="section-heading"><a href="#module-locator" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Locator</span></h3><p>Locators are the mediators between storages and uploads. They represent where an uploaded file was stored so it can be retrieved. They contain a unique id, the name of the storage to which the file was uploaded, and a map of user defined metadata.</p><p>Locator also implements the upload protocol, which means moving a file from one storage to another is straightforward, and very useful for &quot;promoting&quot; a file from temporary (e.g. Disk) to permanent (e.g. S3) storage&lt;sup&gt;2&lt;/sup&gt;:</p><pre><code class="makeup elixir" translate="no"><span class="n">old_file_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8685194111-1">%</span><span class="nc" data-group-id="8685194111-1">Locator</span><span class="p" data-group-id="8685194111-1">{</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/file.jpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">Disk</span><span class="p">,</span><span class="w"> </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8685194111-2">%{</span><span class="p" data-group-id="8685194111-2">}</span><span class="p" data-group-id="8685194111-1">}</span><span class="w">
</span><span class="p" data-group-id="8685194111-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_id</span><span class="p" data-group-id="8685194111-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">S3</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="8685194111-4">(</span><span class="n">old_file_data</span><span class="p" data-group-id="8685194111-4">)</span><span class="err">`</span></code></pre><p>Note: always remember to take care of cleaning up the old file as Entrepot <em>never</em> automatically removes files:</p><p><code class="inline">Disk.delete(old_file_data.id)</code></p><h3 id="module-uploader" class="section-heading"><a href="#module-uploader" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Uploader</span></h3><p>This helper was added in order to support DRYing up storage access. In most apps, there are certain types of assets that will be uploaded and handled in a similar, if not the same way, if only when it comes to where they are stored. You can <code class="inline">use</code> the uploader to codify the handling for specific types of assets.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">AvatarUploader</span><span class="w"> </span><span class="k" data-group-id="1045009246-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Entrepot.Uploader</span><span class="p">,</span><span class="w"> </span><span class="ss">storages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1045009246-2">[</span><span class="ss">cache</span><span class="p">:</span><span class="w"> </span><span class="nc">Disk</span><span class="p">,</span><span class="w"> </span><span class="ss">store</span><span class="p">:</span><span class="w"> </span><span class="nc">S3</span><span class="p" data-group-id="1045009246-2">]</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">build_options</span><span class="p" data-group-id="1045009246-3">(</span><span class="n">upload</span><span class="p">,</span><span class="w"> </span><span class="ss">:cache</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="1045009246-3">)</span><span class="w"> </span><span class="k" data-group-id="1045009246-4">do</span><span class="w">
    </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="1045009246-5">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:prefix</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cache/</span><span class="si" data-group-id="1045009246-6">#{</span><span class="nc">Date</span><span class="o">.</span><span class="n">utc_today</span><span class="p" data-group-id="1045009246-7">(</span><span class="p" data-group-id="1045009246-7">)</span><span class="si" data-group-id="1045009246-6">}</span><span class="s">&quot;</span><span class="p" data-group-id="1045009246-5">)</span><span class="w">
  </span><span class="k" data-group-id="1045009246-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">build_options</span><span class="p" data-group-id="1045009246-8">(</span><span class="n">upload</span><span class="p">,</span><span class="w"> </span><span class="ss">:store</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="1045009246-8">)</span><span class="w"> </span><span class="k" data-group-id="1045009246-9">do</span><span class="w">
    </span><span class="n">opts</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="1045009246-10">(</span><span class="ss">:prefix</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;users/</span><span class="si" data-group-id="1045009246-11">#{</span><span class="n">opts</span><span class="p" data-group-id="1045009246-12">[</span><span class="ss">:user_id</span><span class="p" data-group-id="1045009246-12">]</span><span class="si" data-group-id="1045009246-11">}</span><span class="s">/avatar&quot;</span><span class="p" data-group-id="1045009246-10">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">drop</span><span class="p" data-group-id="1045009246-13">(</span><span class="p" data-group-id="1045009246-14">[</span><span class="ss">:user_id</span><span class="p" data-group-id="1045009246-14">]</span><span class="p" data-group-id="1045009246-13">)</span><span class="w">
  </span><span class="k" data-group-id="1045009246-9">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">build_metadata</span><span class="p" data-group-id="1045009246-15">(</span><span class="n">upload</span><span class="p">,</span><span class="w"> </span><span class="ss">:store</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1045009246-15">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1045009246-16">[</span><span class="ss">uploaded_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="1045009246-17">(</span><span class="p" data-group-id="1045009246-17">)</span><span class="p" data-group-id="1045009246-16">]</span><span class="w">
</span><span class="k" data-group-id="1045009246-1">end</span></code></pre><p>Then you can get the files where they need to be without constructing all the options everywhere they might be uploaded: <code class="inline">AvatarUploader.store(upload, :store, user_id: 1)</code></p><p>Note: as this example demonstrates, the function can receive arbitrary data and use it to customize how it builds the storage options before they are passed on.</p><h2 id="module-built-in-integrations" class="section-heading"><a href="#module-built-in-integrations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Built-in Integrations</span></h2><p>Entrepôt's module design is intended to make it easy to implement your own custom utilities for handling files in the way you need. However, anticipating the most common use cases, that is facilitated with the following optional modules and add-on library.</p><p>There are several implementations some common file storages (including S3/Digital Ocean) and uploads (including <a href="https://hexdocs.pm/plug/1.18.1/Plug.Upload.html"><code class="inline">Plug.Upload</code></a>).</p><h2 id="module-storages" class="section-heading"><a href="#module-storages" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Storages</span></h2><p>Entrepôt ships with the following storage implementations:</p><ul><li><a href="#Disk">Disk</a></li><li><a href="#S3">S3</a></li><li><a href="#RAM">RAM</a></li></ul><h3 id="module-disk" class="section-heading"><a href="#module-disk" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Disk</span></h3><p>This saves uploaded files to a local disk. It is useful for caching uploads while you validate other data, and/or perform some file processing.</p><h4>configuration</h4><ul><li>To set the root directory where files will be stored: <code class="inline">Application.put_env(:entrepot, Entrepot.Storages.Disk, root_dir: &quot;tmp&quot;)</code></li></ul><h4>options</h4><ul><li><code class="inline">prefix</code>: This should be a valid system path that will be appended to the root. If it does not exist, Disk will create it.</li><li><code class="inline">force</code>: If this option is set to a truthy value, Disk will overwrite any existing file at the derived path. Use with caution!</li></ul><h4>notes</h4><p>Since it is possible for files with the same name to be uploaded multiple times, Disk needs some additional info to uniquely identify the file. Disk <em>does not</em> overwrite files with the same name by default. To ensure an upload can be stored, the combination of the <code class="inline">Upload.name</code> and <code class="inline">prefix</code> should be unique.</p><h3 id="module-s3" class="section-heading"><a href="#module-s3" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">S3</span></h3><p>This storage uploads files to <a href="https://aws.amazon.com/s3/">AWS's S3</a> service. It also works with <a href="https://www.digitalocean.com/products/spaces/">Digital Ocean Spaces</a>.</p><h4>configuration</h4><ul><li>To set the bucket where files will be stored: <code class="inline">Application.put_env(:entrepot, Entrepot.Storages.S3, bucket: &quot;whatever&quot;)</code></li></ul><h4>options</h4><ul><li>prefix: A string to prepend to the upload's key</li><li>s3_options: Keyword list of option that will passed directly to ex_aws_s3</li></ul><h4>dependencies</h4><p>Some of the implementations might require further dependencies (currently only <a href="#s3">S3</a>-compatible storage) that you will also need to add to your project's deps</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="6676362028-1">{</span><span class="ss">:ex_aws</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 2.0&quot;</span><span class="p" data-group-id="6676362028-1">}</span><span class="w">
</span><span class="p" data-group-id="6676362028-2">{</span><span class="ss">:ex_aws_s3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 2.0&quot;</span><span class="p" data-group-id="6676362028-2">}</span></code></pre><h3 id="module-ram" class="section-heading"><a href="#module-ram" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">RAM</span></h3><p>Uses Elixir's <a href="https://hexdocs.pm/elixir/StringIO.html">StringIO</a> module to store file contents in memory. Since the &quot;files&quot; are essentially just strings, they will not be persisted and will error if they are read back from a database, for example. However, operations are correspondingly very fast and thus suitable for tests or other temporary file operations.</p><h2 id="module-uploads" class="section-heading"><a href="#module-uploads" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">uploads</span></h2><p>There are implementation of the <a href="./Entrepot.Upload.html"><code class="inline">Entrepot.Upload</code></a> protocol for the following modules:</p><ul><li><a href="#URI">URI</a></li><li><a href="#plugupload">Plug.Upload</a></li></ul><h3 id="module-uri" class="section-heading"><a href="#module-uri" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">URI</span></h3><p>This is useful for transferring files already hosted elsewhere, for example in cloud storage not controlled by your application, or a <a href="https://tus.io/">TUS server</a>.</p><p>You can use it to allow users to post a url string in lieu of downloading and reuploading a file. A Phoenix controller action implementing this feature might look like this:</p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">attach</span><span class="p" data-group-id="7918486880-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7918486880-2">%{</span><span class="s">&quot;attachment&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7918486880-3">%{</span><span class="s">&quot;url&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">url</span><span class="p" data-group-id="7918486880-3">}</span><span class="p" data-group-id="7918486880-2">}</span><span class="p" data-group-id="7918486880-1">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="k" data-group-id="7918486880-4">do</span><span class="w">
  </span><span class="nc">URI</span><span class="o">.</span><span class="n">parse</span><span class="p" data-group-id="7918486880-5">(</span><span class="n">url</span><span class="p" data-group-id="7918486880-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Disk</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="7918486880-6">(</span><span class="n">upload</span><span class="p" data-group-id="7918486880-6">)</span><span class="w">

  </span><span class="c1"># ...redirect, etc</span><span class="w">
</span><span class="k" data-group-id="7918486880-4">end</span></code></pre><h4>notes</h4><p>This implementation imposes a hard timeout limit of 15 seconds to download the file from the remote location.</p><h3 id="module-plug-upload" class="section-heading"><a href="#module-plug-upload" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Plug.Upload</span></h3><p>This supports multi-part form submissions handled by <a href="https://hexdocs.pm/plug/Plug.Upload.html#content">Plug</a>.</p><h2 id="module-entrepôtecto" class="section-heading"><a href="#module-entrepôtecto" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text"><a href="https://github.com/bonfire-networks/entrepot_ecto">EntrepôtEcto</a></span></h2><p>There is an external library (because it needs Ecto as a dependency) which provides <a href="./Entrepot.Ecto.Type.html"><code class="inline">Entrepot.Ecto.Type</code></a> for Ecto schema fields to easily handle persisting Locator data in your repository.</p><hr class="thin"/><p>Note: Entrepôt was originally forked from <a href="https://github.com/elixir-capsule">Capsule</a></p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#add_metadata/2" data-no-tooltip="" translate="no">add_metadata(locator, data)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#add_metadata/3" data-no-tooltip="" translate="no">add_metadata(locator, key, val)</a>

      </div>

        <div class="summary-synopsis"><p>Adds metadata to a Locator.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#copy/3" data-no-tooltip="" translate="no">copy(locator, dest_storage, opts \\ [])</a>

      </div>

        <div class="summary-synopsis"><p>Copies a file from one storage to another.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#storage!/1" data-no-tooltip="" translate="no">storage!(locator)</a>

      </div>

        <div class="summary-synopsis"><p>Resolves the storage module from a Locator.</p></div>

    </div>

</div>

  </section>


  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>

    <div class="functions-list">
<section class="detail" id="add_metadata/2">

  <div class="detail-header">
    <a href="#add_metadata/2" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">add_metadata(locator, data)</h1>


        <a href="https://github.com/bonfire-networks/entrepot/blob/main/lib/entrepot.ex#L83" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="add_metadata/3">

  <div class="detail-header">
    <a href="#add_metadata/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">add_metadata(locator, key, val)</h1>


        <a href="https://github.com/bonfire-networks/entrepot/blob/main/lib/entrepot.ex#L80" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Adds metadata to a Locator.</p><h2 id="add_metadata/3-parameters" class="section-heading"><a href="#add_metadata/3-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">locator</code>: A <code class="inline">Locator</code> struct to which metadata will be added.</li><li><code class="inline">key</code>: A key for the metadata (when adding a single key-value pair).</li><li><code class="inline">val</code>: A value for the metadata (when adding a single key-value pair).</li><li><code class="inline">data</code>: A map or keyword list of metadata to be added.</li></ul><h2 id="add_metadata/3-returns" class="section-heading"><a href="#add_metadata/3-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><ul><li><code class="inline">{:ok, Locator.t()}</code>: An updated <code class="inline">Locator</code> struct with the new metadata.</li><li><code class="inline">{:error, term()}</code>: The original error tuple if given an error tuple.</li></ul><h2 id="add_metadata/3-examples" class="section-heading"><a href="#add_metadata/3-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Examples</span></h2><pre><code class="makeup elixir" translate="no"><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot</span><span class="o">.</span><span class="n">add_metadata</span><span class="p" data-group-id="6431010952-1">(</span><span class="p" data-group-id="6431010952-2">%</span><span class="nc" data-group-id="6431010952-2">Locator</span><span class="p" data-group-id="6431010952-2">{</span><span class="p" data-group-id="6431010952-2">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="6431010952-1">)</span><span class="w">
</span><span class="p" data-group-id="6431010952-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6431010952-4">%</span><span class="nc" data-group-id="6431010952-4">Locator</span><span class="p" data-group-id="6431010952-4">{</span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6431010952-5">%{</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="6431010952-5">}</span><span class="p" data-group-id="6431010952-4">}</span><span class="p" data-group-id="6431010952-3">}</span><span class="w">

</span><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot</span><span class="o">.</span><span class="n">add_metadata</span><span class="p" data-group-id="6431010952-6">(</span><span class="p" data-group-id="6431010952-7">%</span><span class="nc" data-group-id="6431010952-7">Locator</span><span class="p" data-group-id="6431010952-7">{</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="6431010952-7">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6431010952-8">%{</span><span class="ss">key2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value2&quot;</span><span class="p" data-group-id="6431010952-8">}</span><span class="p" data-group-id="6431010952-6">)</span><span class="w">
</span><span class="p" data-group-id="6431010952-9">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6431010952-10">%</span><span class="nc" data-group-id="6431010952-10">Locator</span><span class="p" data-group-id="6431010952-10">{</span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6431010952-11">%{</span><span class="ss">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value1&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">key2</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;value2&quot;</span><span class="p" data-group-id="6431010952-11">}</span><span class="p" data-group-id="6431010952-10">}</span><span class="p" data-group-id="6431010952-9">}</span></code></pre>
  </section>
</section>
<section class="detail" id="copy/3">

    <span id="copy/2"></span>

  <div class="detail-header">
    <a href="#copy/3" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">copy(locator, dest_storage, opts \\ [])</h1>


        <a href="https://github.com/bonfire-networks/entrepot/blob/main/lib/entrepot.ex#L32" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Copies a file from one storage to another.</p><h2 id="copy/3-parameters" class="section-heading"><a href="#copy/3-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">locator</code>: A <code class="inline">Locator</code> struct representing the file to be copied.</li><li><code class="inline">dest_storage</code>: The destination storage module.</li><li><code class="inline">opts</code>: Optional keyword list of options to be passed to the storage modules.</li></ul><h2 id="copy/3-returns" class="section-heading"><a href="#copy/3-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><ul><li><code class="inline">{:ok, Locator.t()}</code>: A new <code class="inline">Locator</code> struct for the copied file.</li><li><code class="inline">{:error, term()}</code>: An error tuple if the copy operation fails.</li></ul><h2 id="copy/3-raises" class="section-heading"><a href="#copy/3-raises" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Raises</span></h2><ul><li>Raises an error if attempting to copy a file to the same storage.</li></ul><h2 id="copy/3-examples" class="section-heading"><a href="#copy/3-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Examples</span></h2><pre><code class="makeup elixir" translate="no"><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot</span><span class="o">.</span><span class="n">copy</span><span class="p" data-group-id="5030760256-1">(</span><span class="p" data-group-id="5030760256-2">%</span><span class="nc" data-group-id="5030760256-2">Locator</span><span class="p" data-group-id="5030760256-2">{</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">Disk</span><span class="p" data-group-id="5030760256-2">}</span><span class="p">,</span><span class="w"> </span><span class="nc">S3</span><span class="p" data-group-id="5030760256-1">)</span><span class="w">
</span><span class="p" data-group-id="5030760256-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5030760256-4">%</span><span class="nc" data-group-id="5030760256-4">Locator</span><span class="p" data-group-id="5030760256-4">{</span><span class="ss">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;new_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">S3</span><span class="p">,</span><span class="w"> </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5030760256-5">%{</span><span class="ss">copied_from</span><span class="p">:</span><span class="w"> </span><span class="nc">Disk</span><span class="p" data-group-id="5030760256-5">}</span><span class="p" data-group-id="5030760256-4">}</span><span class="p" data-group-id="5030760256-3">}</span></code></pre>
  </section>
</section>
<section class="detail" id="storage!/1">

  <div class="detail-header">
    <a href="#storage!/1" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">storage!(locator)</h1>


        <a href="https://github.com/bonfire-networks/entrepot/blob/main/lib/entrepot.ex#L114" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">

<p>Resolves the storage module from a Locator.</p><h2 id="storage!/1-parameters" class="section-heading"><a href="#storage!/1-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Parameters</span></h2><ul><li><code class="inline">locator</code>: A <code class="inline">Locator</code> struct containing the storage information.</li></ul><h2 id="storage!/1-returns" class="section-heading"><a href="#storage!/1-returns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Returns</span></h2><ul><li>The resolved storage module as an atom.</li></ul><h2 id="storage!/1-raises" class="section-heading"><a href="#storage!/1-raises" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Raises</span></h2><ul><li><code class="inline">InvalidStorage</code>: If the storage module cannot be resolved.</li></ul><h2 id="storage!/1-examples" class="section-heading"><a href="#storage!/1-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Examples</span></h2><pre><code class="makeup elixir" translate="no"><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot</span><span class="o">.</span><span class="n">storage!</span><span class="p" data-group-id="6861883015-1">(</span><span class="p" data-group-id="6861883015-2">%</span><span class="nc" data-group-id="6861883015-2">Locator</span><span class="p" data-group-id="6861883015-2">{</span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="nc">Disk</span><span class="p" data-group-id="6861883015-2">}</span><span class="p" data-group-id="6861883015-1">)</span><span class="w">
</span><span class="nc">Disk</span><span class="w">

</span><span class="gp unselectable">iex&gt; </span><span class="nc">Entrepot</span><span class="o">.</span><span class="n">storage!</span><span class="p" data-group-id="6861883015-3">(</span><span class="p" data-group-id="6861883015-4">%</span><span class="nc" data-group-id="6861883015-4">Locator</span><span class="p" data-group-id="6861883015-4">{</span><span class="ss">storage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Elixir.Disk&quot;</span><span class="p" data-group-id="6861883015-4">}</span><span class="p" data-group-id="6861883015-3">)</span><span class="w">
</span><span class="nc">Disk</span></code></pre>
  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Bonfire.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.4) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
