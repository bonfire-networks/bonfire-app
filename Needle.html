<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="Bonfire v1.0.0-social-rc.1.11">


    <title>Needle â€” Bonfire v1.0.0-social-rc.1.11</title>

    <link rel="stylesheet" href="dist/html-elixir-KV3YOVJ3.css" />

    <script defer src="dist/sidebar_items-09D6F6F4.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://bonfirenetworks.org" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Bonfire" />
        </a>

      <div>
        <a href="https://bonfirenetworks.org" class="sidebar-projectName" translate="no">
Bonfire
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.0.0-social-rc.1.11
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-module" id="main" data-type="modules">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Bonfire</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>
      <span translate="no">Needle</span> 
      <small class="app-vsn" translate="no">(Bonfire v1.0.0-social-rc.1.11)</small>

    </h1>

      <a href="https://github.com/bonfire-networks/needle/blob/main/lib/needle.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


    <section id="moduledoc">
<blockquote><p>One foreign key to rule them all and in the darkness, bind them. - Gandalf, paraphrased.</p></blockquote><p><a href="https://hex.pm/packages/needle"><img src="https://img.shields.io/hexpm/v/needle" alt="hex.pm"/></a>
<a href="https://hexdocs.pm/needle">hexdocs</a></p><h2 id="module-intro" class="section-heading"><a href="#module-intro" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Intro</span></h2><p>Bonfire uses the excellent PostgreSQL database for most data storage. PostgreSQL allows us to make a wide range of queries and to make them relatively fast while upholding data integrity guarantees.</p><p>Postgres is a relational schema-led database - it expects you to pre-define tables and the fields in each table (represented in tabular form, i.e. as a collection of tables with each table consisting of a set of rows and columns). Fields can contain data or a reference to a row in another table. </p><p>This usually means that a field containing a reference has to be pre-defined with a foreign key pointing to a specific field (typically a primary key, like an ID column) <em>in a specific table</em>. </p><p>A simple example would be a blogging app, which might have a <code class="inline">post</code> table with <code class="inline">author</code> field that references the <code class="inline">user</code> table.</p><p>A social network, by contrast, is actually a graph of objects. Objects need to be able to refer to other objects by their ID without knowing their type. </p><p>A simple example would be likes, you might have a <code class="inline">likes</code> table with <code class="inline">liked_post_id</code> field that references the <code class="inline">post</code> table. But you don't just have posts that can be liked, but also videos, images, polls, etc, each with their own table, but probably do not want to have to add <code class="inline">liked_video_id</code>, <code class="inline">liked_image_id</code>, etc?</p><p>We needed the flexibility to have a foreign key that can reference any referenceable object. We call our system <a href="./Needle.html"><code class="inline">Needle</code></a>.</p><p>This guide is a brief introduction to Needle. It assumes some foundational knowledge:</p><ul><li><p>Basic understanding of how relational databases like Postgresql work, in particular:</p><ul><li>Tables being made up of fields.</li><li>What a primary key is and why it's useful.</li><li>Foreign keys and relationships between tables (1 to 1, 1 to Many, Many to 1, Many to Many).</li><li>Views as virtual tables backed by a SQL query.</li></ul></li><li><p>Basic understanding of Elixir (enough to follow the examples).</p></li><li><p>Basic working knowledge of the <a href="https://hexdocs.pm/ecto/Ecto.html">Ecto</a> database library (schema and migration definitions)</p></li></ul><h2 id="module-what-is-needle" class="section-heading"><a href="#module-what-is-needle" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What is Needle?</span></h2><p>A means of foreign keying many tables in one field. Designed for highly interlinked data in highly dynamic schemata where tracking all the foreign keys is neither desired nor practical.</p><blockquote><p>A universal foreign key is actually a hard problem. Many approaches are on offer with a variety of tradeoffs. If plugging into Bonfire's Needle-based core extensions isn't a requirement for you (i.e. you don't need to put things into feeds or use boundaries for access-control) should carefully consider a variety of approaches rather than just blindly adopting the one that fitted our project's needs the best!</p></blockquote><h2 id="module-identifying-objects-the-uid-type" class="section-heading"><a href="#module-identifying-objects-the-uid-type" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Identifying objects - the UID type</span></h2><p>All referenceable objects in the system have a unique ID (primary key) whose type is the <a href="./Needle.UID.html"><code class="inline">Needle.UID</code></a>. <code class="inline">UUIDv7</code> and <a href="https://github.com/ulid/spec">ULIDs</a> are a lot like standard <code class="inline">UUID</code> in that you can generate unique ones independently of the database. It's also a little different, being made up of two parts:</p><ul><li>The current timestamp, to millisecond precision.</li><li>Strong random padding for uniqueness.</li></ul><p>This means that it naturally sorts by time to the millisecond (close enough for us), giving us a performance advantage compared to queries ordered by a separate creation datetime field (by contrast, UUIDv4 is randomly distributed).</p><p>If you've only worked with integer primary keys before, you are probably used to letting the database dispense an ID for you. With <code class="inline">ULID</code> (or <code class="inline">UUID</code>), IDs can be known <em>before</em> they are stored, greatly easing the process of storing a graph of data and allowing us to do more of the preparation work outside of a transaction for increased performance.</p><p>In PostgreSQL, we actually store <code class="inline">UUIDv7</code> and <code class="inline">ULID</code>s as <code class="inline">UUID</code> columns, thanks to both being the same size (and the lack of specific column types shipping with postgresql). You mostly will not notice this because it's handled for you, but there are a few places it can come up:</p><ul><li>Ecto debug and error output may show either binary values or UUID-formatted values.</li><li>Hand-written SQL may need to convert table IDs to the <code class="inline">UUID</code> format before use.</li></ul><h2 id="module-it-s-just-a-table" class="section-heading"><a href="#module-it-s-just-a-table" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">It's just a table</span></h2><p>The <a href="./Needle.html"><code class="inline">Needle</code></a> system is mostly based around a single table represented by the <a href="./Needle.Pointer.html"><code class="inline">Needle.Pointer</code></a> schema with the following fields:</p><ul><li><code class="inline">id</code> (UID) - the database-wide unique id for the object, primary key.</li><li><code class="inline">table_id</code> (UID) - identifies the type of the object, references <a href="./Needle.Table.html"><code class="inline">Needle.Table</code></a>.</li><li><code class="inline">deleted_at</code> (timestamp, default: <code class="inline">null</code>) - when the object was deleted.</li></ul><p>Every object that is stored in the system will have a record in this table. It may also have records in other tables (handy for storing more than 3 fields about the object!).</p><p>A <code class="inline">Table</code> is a record of a table that may be linked to by a pointer. A <code class="inline">Pointer</code> is a pointer ID and a table ID.
With these two ingredients, we can construct a means of pointing to any table that has a <code class="inline">Table</code> entry.</p><p>But don't worry about <a href="./Needle.Table.html"><code class="inline">Needle.Table</code></a> for now, just know that every object type will have a record there so <code class="inline">Needle.Pointer.table_id</code> can reference it.</p><h2 id="module-installation" class="section-heading"><a href="#module-installation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Installation</span></h2><p>Aside from adding the dependency, you will also need to write add a migration to set up the database before you can start writing your regular migrations:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Repo.Migrations.InitPointers</span><span class="w"> </span><span class="k" data-group-id="4925700389-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">up</span><span class="p" data-group-id="4925700389-2">(</span><span class="p" data-group-id="4925700389-2">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">inits</span><span class="p" data-group-id="4925700389-3">(</span><span class="ss">:up</span><span class="p" data-group-id="4925700389-3">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">down</span><span class="p" data-group-id="4925700389-4">(</span><span class="p" data-group-id="4925700389-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">inits</span><span class="p" data-group-id="4925700389-5">(</span><span class="ss">:down</span><span class="p" data-group-id="4925700389-5">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">inits</span><span class="p" data-group-id="4925700389-6">(</span><span class="n">dir</span><span class="p" data-group-id="4925700389-6">)</span><span class="w"> </span><span class="k" data-group-id="4925700389-7">do</span><span class="w">
    </span><span class="n">init_pointers_ulid_extra</span><span class="p" data-group-id="4925700389-8">(</span><span class="n">dir</span><span class="p" data-group-id="4925700389-8">)</span><span class="w"> </span><span class="c1"># this one is optional but recommended</span><span class="w">
    </span><span class="n">init_pointers</span><span class="p" data-group-id="4925700389-9">(</span><span class="n">dir</span><span class="p" data-group-id="4925700389-9">)</span><span class="w"> </span><span class="c1"># this one is not optional</span><span class="w">
  </span><span class="k" data-group-id="4925700389-7">end</span><span class="w">
</span><span class="k" data-group-id="4925700389-1">end</span></code></pre><blockquote><p>Note: Pointers is already a default dependency of most Bonfire extensions, so you shouldn't need to add the migration if building a new extension.</p></blockquote><h2 id="module-declaring-object-types" class="section-heading"><a href="#module-declaring-object-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Declaring Object Types</span></h2><h3 id="module-picking-a-table-id" class="section-heading"><a href="#module-picking-a-table-id" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Picking a table id</span></h3><p>The first step to declaring a new type is picking a unique table ID in UID format. </p><p>You could just generate a random UID, but since these IDs are special, we tend to assign a synthetic UID that are readable as words so they stand out in debug output.</p><p>For example, the ID for the <code class="inline">Feed</code> table is: <code class="inline">1TFEEDS0NTHES0V1S0FM0RTA1S</code>, which can be read as &quot;It feeds on the souls of mortals&quot;. Feel free to have a little fun coming up with them, it makes debug output a little more cheery! The rules are:</p><ul><li>The alphabet is <a href="https://en.wikipedia.org/wiki/Base32#Crockford's_Base32">Crockford's Base32</a>.</li><li>They must be 26 characters in length.</li><li>The first character must be a digit in the range 0-7.</li></ul><p>To help you with this, the <a href="./Needle.UID.html#synthesise!/1"><code class="inline">Needle.UID.synthesise!/1</code></a> method takes an alphanumeric binary and tries to return you it transliterated into a valid UID. Example usage:</p><pre><code class="makeup elixir" translate="no"><span class="gp unselectable">iex(1)&gt; </span><span class="nc">Needle.UID</span><span class="o">.</span><span class="n">synthesise!</span><span class="p" data-group-id="2131415284-1">(</span><span class="s">&quot;itfeedsonthesouls&quot;</span><span class="p" data-group-id="2131415284-1">)</span><span class="w">

</span><span class="mi">11</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">28.299</span><span class="w"> </span><span class="p" data-group-id="2131415284-2">[</span><span class="n">error</span><span class="p" data-group-id="2131415284-2">]</span><span class="w"> </span><span class="nc">Too</span><span class="w"> </span><span class="n">short</span><span class="p">,</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">chars</span><span class="o">.</span><span class="w">
</span><span class="ss">:ok</span><span class="w">
</span><span class="gp unselectable">iex(2)&gt; </span><span class="nc">Needle.UID</span><span class="o">.</span><span class="n">synthesise!</span><span class="p" data-group-id="2131415284-3">(</span><span class="s">&quot;itfeedsonthesoulsofmortalsandothers&quot;</span><span class="p" data-group-id="2131415284-3">)</span><span class="w">

</span><span class="mi">11</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">31.819</span><span class="w"> </span><span class="p" data-group-id="2131415284-4">[</span><span class="n">warn</span><span class="p" data-group-id="2131415284-4">]</span><span class="w">  </span><span class="nc">Too</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">chopping</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">chars</span><span class="w">
</span><span class="s">&quot;1TFEEDS0NTHES0V1S0FM0RTA1S&quot;</span><span class="w">
</span><span class="gp unselectable">iex(3)&gt; </span><span class="nc">Needle.UID</span><span class="o">.</span><span class="n">synthesise!</span><span class="p" data-group-id="2131415284-5">(</span><span class="s">&quot;itfeedsonthesoulsofmortals&quot;</span><span class="p" data-group-id="2131415284-5">)</span><span class="w">
</span><span class="s">&quot;1TFEEDS0NTHES0V1S0FM0RTA1S&quot;</span><span class="w">
</span><span class="gp unselectable">iex(4)&gt; </span><span class="nc">Needle.UID</span><span class="o">.</span><span class="n">synthesise!</span><span class="p" data-group-id="2131415284-6">(</span><span class="s">&quot;gtfeedsonthesoulsofmortals&quot;</span><span class="p" data-group-id="2131415284-6">)</span><span class="w">

</span><span class="mi">11</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">03.268</span><span class="w"> </span><span class="p" data-group-id="2131415284-7">[</span><span class="n">warn</span><span class="p" data-group-id="2131415284-7">]</span><span class="w">  </span><span class="nc">First</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">digit</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">replacing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="mi">7</span><span class="w">
</span><span class="s">&quot;7TFEEDS0NTHES0V1S0FM0RTA1S&quot;</span></code></pre><h3 id="module-virtual-pointables-virtuals" class="section-heading"><a href="#module-virtual-pointables-virtuals" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Virtual pointables (&quot;virtuals&quot;)</span></h3><p><a href="./Needle.Virtual.html"><code class="inline">Needle.Virtual</code></a> is the simplest and most common type of object. Here's a definition of block:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Block</span><span class="w"> </span><span class="k" data-group-id="1747496563-1">do</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Needle.Virtual</span><span class="p">,</span><span class="w">
    </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:bonfire_data_social</span><span class="p">,</span><span class="w">
    </span><span class="ss">table_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;310CK1NGSTVFFAV01DSSEE1NG1&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">source</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bonfire_data_social_block&quot;</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Bonfire.Data.Edges.Edge</span><span class="w">

  </span><span class="n">virtual_schema</span><span class="w"> </span><span class="k" data-group-id="1747496563-2">do</span><span class="w">
    </span><span class="n">has_one</span><span class="w"> </span><span class="ss">:edge</span><span class="p">,</span><span class="w"> </span><span class="nc">Edge</span><span class="p">,</span><span class="w"> </span><span class="ss">foreign_key</span><span class="p">:</span><span class="w"> </span><span class="ss">:id</span><span class="w">
  </span><span class="k" data-group-id="1747496563-2">end</span><span class="w">
</span><span class="k" data-group-id="1747496563-1">end</span></code></pre><p>It should look quite similar to a mixin definition, except that we <code class="inline">use</code> <a href="./Needle.Virtual.html"><code class="inline">Needle.Virtual</code></a> this time (passing an additional <code class="inline">table_id</code> argument) and we call the <code class="inline">virtual_schema</code> macro.</p><p>The primary limitation of a virtual is that you cannot put extra fields on it. This also means that <code class="inline">belongs_to</code> is not generally permitted because it results in adding a field, while <code class="inline">has_one</code> and <code class="inline">has_many</code> work just fine as they do not cause the creation of fields in the schema.</p><p>This is not usually a problem, as extra fields can be put into <a href="mixins-storing-data-about-objects">mixins</a> or <a href="#multimixins">multimixins</a> as appropriate.</p><p>In all other respects, they behave like Pointables. You can have changesets over them and select and insert as usual.</p><blockquote><p>Under the hood, a virtual has a writable view (in the above example, called <code class="inline">bonfire_data_social_block</code>). It looks like a table with just an id, but it's populated with all the ids of blocks that have not been deleted. When the view is inserted into, a record is created in the <code class="inline">pointers</code> table for you transparently. When you delete from the view, the corresponding <code class="inline">pointers</code> entry is marked deleted for you.</p></blockquote><blockquote><p>Before introducing Virtuals, we noticed it was very common to create Pointables with no extra fields just so we could use the Needle system. Virtuals are alternative for this case that requires less typing and provides a reduced overhead vs pointable (as they save the cost of maintaining a primary key in that table and the associated disk space).</p></blockquote><h3 id="module-pointables" class="section-heading"><a href="#module-pointables" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Pointables</span></h3><p>The other, lesser used, type of object is called the <a href="./Needle.Pointable.html"><code class="inline">Needle.Pointable</code></a>. The major difference is that unlike the simple case of virtuals, pointables are not backed by views, but by tables.</p><blockquote><p>When a record is inserted into a pointable table, a copy is made in the <code class="inline">pointers</code> table for you transparently. When you delete from the table, the the corresponding <code class="inline">pointers</code> entry is marked deleted for you. In these ways, they behave very much like virtuals. By having a table, however, we are free to add new fields.</p></blockquote><p>Pointables pay for this flexibility by being slightly more expensive than virtuals:</p><ul><li>Records must be inserted into/deleted from two tables (the pointable's table and the <code class="inline">pointers</code> table).</li><li>The pointable table needs its own primary key index.</li></ul><p>The choice of using a pointable instead of a virtual combined with one or more mixins is ultimately up to you.</p><p>Here is a definition of a pointable type (indicating an ActivityPub activity whose type we don't recognise, stored as a JSON blob):</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.APActivity</span><span class="w"> </span><span class="k" data-group-id="7297753156-1">do</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Needle.Pointable</span><span class="p">,</span><span class="w">
    </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:bonfire_data_social</span><span class="p">,</span><span class="w">
    </span><span class="ss">table_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30NF1REAPACTTAB1ENVMBER0NE&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">source</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bonfire_data_social_apactivity&quot;</span><span class="w">

  </span><span class="n">pointable_schema</span><span class="w"> </span><span class="k" data-group-id="7297753156-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:json</span><span class="p">,</span><span class="w"> </span><span class="ss">:map</span><span class="w">
  </span><span class="k" data-group-id="7297753156-2">end</span><span class="w">
</span><span class="k" data-group-id="7297753156-1">end</span></code></pre><blockquote><p>As you can see, to declare a pointable schema, we start by using <a href="./Needle.Pointable.html"><code class="inline">Needle.Pointable</code></a>, providing the name of our otp application, the source table's name in the database and our chosen sentinel UID.</p></blockquote><blockquote><p>We then call <code class="inline">pointable_schema</code> and define any fields we wish to put directly in the table. For the most part, <code class="inline">pointable_schema</code> is like Ecto's <code class="inline">schema</code> macro, except you do not provide the table name and let it handle the primary key.</p></blockquote><blockquote><p>If for some reason you wished to turn ID autogeneration off, you could pass <code class="inline">autogenerate: false</code> to the options provided when using <a href="./Needle.Pointable.html"><code class="inline">Needle.Pointable</code></a>.</p></blockquote><h2 id="module-adding-re-usable-fields" class="section-heading"><a href="#module-adding-re-usable-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Adding re-usable fields</span></h2><h3 id="module-mixins-storing-data-about-objects" class="section-heading"><a href="#module-mixins-storing-data-about-objects" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Mixins - storing data about objects</span></h3><p>Mixins are tables which contain extra information on behalf of objects. Each object can choose to
record or not record information for each mixin. Sample mixins include:</p><ul><li>user profile (containing a name, location and summary)</li><li>post content (containing the title, summary, and/or html body of a post or message)</li><li>created (containing the id of the object creator)</li></ul><p>In this way, they are reusable across different object types. One mixin may (or may not) be used by any number of objects. This is mostly driven by the type of the object we are storing, but can also be driven by user input.</p><p>Mixins are just tables too! The only requirement is they have a <code class="inline">UID</code> primary key which references <a href="./Needle.Pointer.html"><code class="inline">Needle.Pointer</code></a>. The developer of the mixin is free to put whatever other fields they want in the table, so long as they have that primary-key-as-reference (which will be automatically added for you by the <code class="inline">mixin_schema</code> macro). </p><p>Here is a sample mixin definition for a user profile:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Profile</span><span class="w"> </span><span class="k" data-group-id="8017484681-1">do</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Needle.Mixin</span><span class="p">,</span><span class="w">
    </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:bonfire_data_social</span><span class="p">,</span><span class="w">
    </span><span class="ss">source</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bonfire_data_social_profile&quot;</span><span class="w">

  </span><span class="n">mixin_schema</span><span class="w"> </span><span class="k" data-group-id="8017484681-2">do</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:summary</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:website</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
    </span><span class="n">field</span><span class="w"> </span><span class="ss">:location</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="w">
  </span><span class="k" data-group-id="8017484681-2">end</span><span class="w">
</span><span class="k" data-group-id="8017484681-1">end</span></code></pre><blockquote><p>Mixin tables are not themselves pointable, so there is no need to specify a table id as when defining a pointable schema.</p></blockquote><p>Aside from <code class="inline">use</code>ing <a href="./Needle.Mixin.html"><code class="inline">Needle.Mixin</code></a> instead of <a href="https://hexdocs.pm/ecto/3.12.6/Ecto.Schema.html"><code class="inline">Ecto.Schema</code></a> and calling <code class="inline">mixin_schema</code> instead of
<code class="inline">schema</code>, pretty similar to a standard Ecto schema, right? </p><p>The arguments to <code class="inline">use Needle.Mixin</code> are:</p><ul><li><code class="inline">otp_app</code>: the OTP app name to use when loading dynamic configuration, e.g. the current extension or app (required)</li><li><code class="inline">source</code>: the underlying table name to use in the database</li></ul><p>We will cover dynamic configuration later. For now, you can use the OTP app that includes the module.</p><h3 id="module-multimixins" class="section-heading"><a href="#module-multimixins" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Multimixins</span></h3><p>Multimixins are like mixins, except that where an object may have 0 or 1 of a particular mixins, an object may have any number of a particular multimixin.</p><p>For this to work, a multimixin must have a <em>compound primary key</em> which must contain an <code class="inline">id</code> column referencing <a href="./Needle.Pointer.html"><code class="inline">Needle.Pointer</code></a> and at least one other field which will collectively be unique.</p><p>An example multimixin is used for publishing an item to feeds:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.FeedPublish</span><span class="w"> </span><span class="k" data-group-id="1003134849-1">do</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Needle.Mixin</span><span class="p">,</span><span class="w">
    </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:bonfire_data_social</span><span class="p">,</span><span class="w">
    </span><span class="ss">source</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bonfire_data_social_feed_publish&quot;</span><span class="w">

  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Needle.Pointer</span><span class="w">

  </span><span class="n">mixin_schema</span><span class="w"> </span><span class="k" data-group-id="1003134849-2">do</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:feed</span><span class="p">,</span><span class="w"> </span><span class="nc">Pointer</span><span class="p">,</span><span class="w"> </span><span class="ss">primary_key</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="1003134849-2">end</span><span class="w">
</span><span class="k" data-group-id="1003134849-1">end</span></code></pre><p>Notice that this looks very similar to defining a mixin. Indeed, the only difference is the <code class="inline">primary_key: true</code> in this line, which adds a second field to the compound primary key.
This results in ecto recording a compound primary key of <code class="inline">(id, feed_id)</code> for the schema (the id is added for you as with regular mixins).</p><h2 id="module-writing-migrations" class="section-heading"><a href="#module-writing-migrations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Writing Migrations</span></h2><p>Migrations are typically included along with the schemas as public APIs you can call within your project's migrations.</p><h3 id="module-virtuals" class="section-heading"><a href="#module-virtuals" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Virtuals</span></h3><p>Most virtuals are incredibly simple to migrate for:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Post.Migration</span><span class="w"> </span><span class="k" data-group-id="4198138072-1">do</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Post</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_post</span><span class="p" data-group-id="4198138072-2">(</span><span class="p" data-group-id="4198138072-2">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">migrate_virtual</span><span class="p" data-group-id="4198138072-3">(</span><span class="nc">Post</span><span class="p" data-group-id="4198138072-3">)</span><span class="w">

</span><span class="k" data-group-id="4198138072-1">end</span></code></pre><p>If you need to do more work, it can be a little trickier. Here's an example for <code class="inline">block</code>, which also creates a unique index on another table:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Block.Migration</span><span class="w"> </span><span class="k" data-group-id="8643219241-1">do</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Bonfire.Data.Edges.Edge.Migration</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Block</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_block_view</span><span class="p" data-group-id="8643219241-2">(</span><span class="p" data-group-id="8643219241-2">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">migrate_virtual</span><span class="p" data-group-id="8643219241-3">(</span><span class="nc">Block</span><span class="p" data-group-id="8643219241-3">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_block_unique_index</span><span class="p" data-group-id="8643219241-4">(</span><span class="p" data-group-id="8643219241-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">migrate_type_unique_index</span><span class="p" data-group-id="8643219241-5">(</span><span class="nc">Block</span><span class="p" data-group-id="8643219241-5">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_block</span><span class="p" data-group-id="8643219241-6">(</span><span class="n">dir</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="n">direction</span><span class="p" data-group-id="8643219241-7">(</span><span class="p" data-group-id="8643219241-7">)</span><span class="p" data-group-id="8643219241-6">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_block</span><span class="p" data-group-id="8643219241-8">(</span><span class="ss">:up</span><span class="p" data-group-id="8643219241-8">)</span><span class="w"> </span><span class="k" data-group-id="8643219241-9">do</span><span class="w">
    </span><span class="n">migrate_block_view</span><span class="p" data-group-id="8643219241-10">(</span><span class="p" data-group-id="8643219241-10">)</span><span class="w">
    </span><span class="n">migrate_block_unique_index</span><span class="p" data-group-id="8643219241-11">(</span><span class="p" data-group-id="8643219241-11">)</span><span class="w">
  </span><span class="k" data-group-id="8643219241-9">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_block</span><span class="p" data-group-id="8643219241-12">(</span><span class="ss">:down</span><span class="p" data-group-id="8643219241-12">)</span><span class="w"> </span><span class="k" data-group-id="8643219241-13">do</span><span class="w">
    </span><span class="n">migrate_block_unique_index</span><span class="p" data-group-id="8643219241-14">(</span><span class="p" data-group-id="8643219241-14">)</span><span class="w">
    </span><span class="n">migrate_block_view</span><span class="p" data-group-id="8643219241-15">(</span><span class="p" data-group-id="8643219241-15">)</span><span class="w">
  </span><span class="k" data-group-id="8643219241-13">end</span><span class="w">

</span><span class="k" data-group-id="8643219241-1">end</span></code></pre><p>Notice how we have to write our <code class="inline">up</code> and <code class="inline">down</code> versions separately to get the correct ordering of operations. </p><h3 id="module-pointables-1" class="section-heading"><a href="#module-pointables-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Pointables</span></h3><p>Migration example for a <code class="inline">Pointable</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.APActivity.Migration</span><span class="w"> </span><span class="k" data-group-id="5884857319-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.APActivity</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_apactivity_table</span><span class="p" data-group-id="5884857319-2">(</span><span class="n">exprs</span><span class="p" data-group-id="5884857319-2">)</span><span class="w"> </span><span class="k" data-group-id="5884857319-3">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="5884857319-4">do</span><span class="w">
      </span><span class="kn">require</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
      </span><span class="nc">Needle.Migration</span><span class="o">.</span><span class="n">create_pointable_table</span><span class="p" data-group-id="5884857319-5">(</span><span class="nc">Bonfire.Data.Social.APActivity</span><span class="p" data-group-id="5884857319-5">)</span><span class="w"> </span><span class="k" data-group-id="5884857319-6">do</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:json</span><span class="p">,</span><span class="w"> </span><span class="ss">:jsonb</span><span class="w">
        </span><span class="k">unquote_splicing</span><span class="p" data-group-id="5884857319-7">(</span><span class="n">exprs</span><span class="p" data-group-id="5884857319-7">)</span><span class="w">
      </span><span class="k" data-group-id="5884857319-6">end</span><span class="w">
    </span><span class="k" data-group-id="5884857319-4">end</span><span class="w">
  </span><span class="k" data-group-id="5884857319-3">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">create_apactivity_table</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_apactivity_table</span><span class="p" data-group-id="5884857319-8">(</span><span class="p" data-group-id="5884857319-9">[</span><span class="p" data-group-id="5884857319-9">]</span><span class="p" data-group-id="5884857319-8">)</span><span class="w">
  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">create_apactivity_table</span><span class="p" data-group-id="5884857319-10">(</span><span class="p" data-group-id="5884857319-11">[</span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="5884857319-11">]</span><span class="p" data-group-id="5884857319-10">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_apactivity_table</span><span class="p" data-group-id="5884857319-12">(</span><span class="n">body</span><span class="p" data-group-id="5884857319-12">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">drop_apactivity_table</span><span class="p" data-group-id="5884857319-13">(</span><span class="p" data-group-id="5884857319-13">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">drop_pointable_table</span><span class="p" data-group-id="5884857319-14">(</span><span class="nc">APActivity</span><span class="p" data-group-id="5884857319-14">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">maa</span><span class="p" data-group-id="5884857319-15">(</span><span class="ss">:up</span><span class="p" data-group-id="5884857319-15">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_apactivity_table</span><span class="p" data-group-id="5884857319-16">(</span><span class="p" data-group-id="5884857319-17">[</span><span class="p" data-group-id="5884857319-17">]</span><span class="p" data-group-id="5884857319-16">)</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">maa</span><span class="p" data-group-id="5884857319-18">(</span><span class="ss">:down</span><span class="p" data-group-id="5884857319-18">)</span><span class="w"> </span><span class="k" data-group-id="5884857319-19">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.APActivity.Migration</span><span class="o">.</span><span class="n">drop_apactivity_table</span><span class="p" data-group-id="5884857319-20">(</span><span class="p" data-group-id="5884857319-20">)</span><span class="w">
  </span><span class="k" data-group-id="5884857319-19">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">migrate_apactivity</span><span class="p" data-group-id="5884857319-21">(</span><span class="p" data-group-id="5884857319-21">)</span><span class="w"> </span><span class="k" data-group-id="5884857319-22">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="5884857319-23">do</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">direction</span><span class="p" data-group-id="5884857319-24">(</span><span class="p" data-group-id="5884857319-24">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:up</span><span class="p">,</span><span class="w">
        </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="5884857319-25">(</span><span class="n">maa</span><span class="p" data-group-id="5884857319-26">(</span><span class="ss">:up</span><span class="p" data-group-id="5884857319-26">)</span><span class="p" data-group-id="5884857319-25">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="5884857319-27">(</span><span class="n">maa</span><span class="p" data-group-id="5884857319-28">(</span><span class="ss">:down</span><span class="p" data-group-id="5884857319-28">)</span><span class="p" data-group-id="5884857319-27">)</span><span class="w">
    </span><span class="k" data-group-id="5884857319-23">end</span><span class="w">
  </span><span class="k" data-group-id="5884857319-22">end</span><span class="w">

</span><span class="k" data-group-id="5884857319-1">end</span></code></pre><p>As you can see, this <code class="inline">Pointable</code> migration a little trickier to define than a <code class="inline">Virtual</code> because we wanted to preserve the ability for the user to define extra fields in config. There are some questions about how useful this is in practice, so you could also go for a simpler option:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Repo.Migrations.Greeting</span><span class="w"> </span><span class="k" data-group-id="7709668508-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">up</span><span class="p" data-group-id="7709668508-2">(</span><span class="p" data-group-id="7709668508-2">)</span><span class="w"> </span><span class="k" data-group-id="7709668508-3">do</span><span class="w">
    </span><span class="n">create_pointable_table</span><span class="p" data-group-id="7709668508-4">(</span><span class="ss">:greeting</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GREET1NGSFR0MD0CEXAMP1E000&quot;</span><span class="p" data-group-id="7709668508-4">)</span><span class="w"> </span><span class="k" data-group-id="7709668508-5">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:greeting</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="7709668508-5">end</span><span class="w">
  </span><span class="k" data-group-id="7709668508-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">down</span><span class="p" data-group-id="7709668508-6">(</span><span class="p" data-group-id="7709668508-6">)</span><span class="w"> </span><span class="k" data-group-id="7709668508-7">do</span><span class="w">
    </span><span class="n">drop_pointable_table</span><span class="p" data-group-id="7709668508-8">(</span><span class="ss">:greeting</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GREET1NGSFR0MD0CEXAMP1E000&quot;</span><span class="p" data-group-id="7709668508-8">)</span><span class="w">
  </span><span class="k" data-group-id="7709668508-7">end</span><span class="w">
</span><span class="k" data-group-id="7709668508-1">end</span></code></pre><blockquote><p>As you can see, it's pretty similar to defining a regular migration, except you use <code class="inline">create_pointable_table</code> and
<code class="inline">drop_pointable_table</code>. Notice that our sentinel UID makes an appearance again here. It's <em>very</em> important that these match what we declared in the schema.</p></blockquote><h3 id="module-mixins" class="section-heading"><a href="#module-mixins" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Mixins</span></h3><p>Mixins look much like pointables:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Profile.Migration</span><span class="w"> </span><span class="k" data-group-id="1815581724-1">do</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.Profile</span><span class="w">

  </span><span class="c1"># create_profile_table/{0,1}</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_profile_table</span><span class="p" data-group-id="1815581724-2">(</span><span class="n">exprs</span><span class="p" data-group-id="1815581724-2">)</span><span class="w"> </span><span class="k" data-group-id="1815581724-3">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="1815581724-4">do</span><span class="w">
      </span><span class="kn">require</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
      </span><span class="nc">Needle.Migration</span><span class="o">.</span><span class="n">create_mixin_table</span><span class="p" data-group-id="1815581724-5">(</span><span class="nc">Bonfire.Data.Social.Profile</span><span class="p" data-group-id="1815581724-5">)</span><span class="w"> </span><span class="k" data-group-id="1815581724-6">do</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:name</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:summary</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:website</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:location</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:icon_id</span><span class="p">,</span><span class="w"> </span><span class="n">strong_pointer</span><span class="p" data-group-id="1815581724-7">(</span><span class="nc">Bonfire.Files.Media</span><span class="p" data-group-id="1815581724-7">)</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:image_id</span><span class="p">,</span><span class="w"> </span><span class="n">strong_pointer</span><span class="p" data-group-id="1815581724-8">(</span><span class="nc">Bonfire.Files.Media</span><span class="p" data-group-id="1815581724-8">)</span><span class="w">
        </span><span class="k">unquote_splicing</span><span class="p" data-group-id="1815581724-9">(</span><span class="n">exprs</span><span class="p" data-group-id="1815581724-9">)</span><span class="w">
      </span><span class="k" data-group-id="1815581724-6">end</span><span class="w">
    </span><span class="k" data-group-id="1815581724-4">end</span><span class="w">
  </span><span class="k" data-group-id="1815581724-3">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">create_profile_table</span><span class="p" data-group-id="1815581724-10">(</span><span class="p" data-group-id="1815581724-10">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_profile_table</span><span class="p" data-group-id="1815581724-11">(</span><span class="p" data-group-id="1815581724-12">[</span><span class="p" data-group-id="1815581724-12">]</span><span class="p" data-group-id="1815581724-11">)</span><span class="w">
  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">create_profile_table</span><span class="p" data-group-id="1815581724-13">(</span><span class="p" data-group-id="1815581724-14">[</span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1815581724-15">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="1815581724-15">}</span><span class="p" data-group-id="1815581724-14">]</span><span class="p" data-group-id="1815581724-13">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_profile_table</span><span class="p" data-group-id="1815581724-16">(</span><span class="n">body</span><span class="p" data-group-id="1815581724-16">)</span><span class="w">

  </span><span class="c1"># drop_profile_table/0</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">drop_profile_table</span><span class="p" data-group-id="1815581724-17">(</span><span class="p" data-group-id="1815581724-17">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">drop_mixin_table</span><span class="p" data-group-id="1815581724-18">(</span><span class="nc">Profile</span><span class="p" data-group-id="1815581724-18">)</span><span class="w">

  </span><span class="c1"># migrate_profile/{0,1}</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">mp</span><span class="p" data-group-id="1815581724-19">(</span><span class="ss">:up</span><span class="p" data-group-id="1815581724-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_profile_table</span><span class="p" data-group-id="1815581724-20">(</span><span class="p" data-group-id="1815581724-21">[</span><span class="p" data-group-id="1815581724-21">]</span><span class="p" data-group-id="1815581724-20">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">mp</span><span class="p" data-group-id="1815581724-22">(</span><span class="ss">:down</span><span class="p" data-group-id="1815581724-22">)</span><span class="w"> </span><span class="k" data-group-id="1815581724-23">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="1815581724-24">do</span><span class="w">
      </span><span class="nc">Bonfire.Data.Social.Profile.Migration</span><span class="o">.</span><span class="n">drop_profile_table</span><span class="p" data-group-id="1815581724-25">(</span><span class="p" data-group-id="1815581724-25">)</span><span class="w">
    </span><span class="k" data-group-id="1815581724-24">end</span><span class="w">
  </span><span class="k" data-group-id="1815581724-23">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">migrate_profile</span><span class="p" data-group-id="1815581724-26">(</span><span class="p" data-group-id="1815581724-26">)</span><span class="w"> </span><span class="k" data-group-id="1815581724-27">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="1815581724-28">do</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">direction</span><span class="p" data-group-id="1815581724-29">(</span><span class="p" data-group-id="1815581724-29">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:up</span><span class="p">,</span><span class="w">
        </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="1815581724-30">(</span><span class="n">mp</span><span class="p" data-group-id="1815581724-31">(</span><span class="ss">:up</span><span class="p" data-group-id="1815581724-31">)</span><span class="p" data-group-id="1815581724-30">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="1815581724-32">(</span><span class="n">mp</span><span class="p" data-group-id="1815581724-33">(</span><span class="ss">:down</span><span class="p" data-group-id="1815581724-33">)</span><span class="p" data-group-id="1815581724-32">)</span><span class="w">
    </span><span class="k" data-group-id="1815581724-28">end</span><span class="w">
  </span><span class="k" data-group-id="1815581724-27">end</span><span class="w">

</span><span class="k" data-group-id="1815581724-1">end</span></code></pre><h3 id="module-multimixins-1" class="section-heading"><a href="#module-multimixins-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Multimixins</span></h3><p>Similar to mixins:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.FeedPublish.Migration</span><span class="w"> </span><span class="k" data-group-id="0318870567-1">do</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Bonfire.Data.Social.FeedPublish</span><span class="w">

  </span><span class="na">@feed_publish_table</span><span class="w"> </span><span class="nc">FeedPublish</span><span class="o">.</span><span class="c">__schema__</span><span class="p" data-group-id="0318870567-2">(</span><span class="ss">:source</span><span class="p" data-group-id="0318870567-2">)</span><span class="w">

  </span><span class="c1"># create_feed_publish_table/{0,1}</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_feed_publish_table</span><span class="p" data-group-id="0318870567-3">(</span><span class="n">exprs</span><span class="p" data-group-id="0318870567-3">)</span><span class="w"> </span><span class="k" data-group-id="0318870567-4">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="0318870567-5">do</span><span class="w">
      </span><span class="kn">require</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">
      </span><span class="nc">Needle.Migration</span><span class="o">.</span><span class="n">create_mixin_table</span><span class="p" data-group-id="0318870567-6">(</span><span class="nc">Bonfire.Data.Social.FeedPublish</span><span class="p" data-group-id="0318870567-6">)</span><span class="w"> </span><span class="k" data-group-id="0318870567-7">do</span><span class="w">
        </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">add</span><span class="w"> </span><span class="ss">:feed_id</span><span class="p">,</span><span class="w">
          </span><span class="nc">Needle.Migration</span><span class="o">.</span><span class="n">strong_pointer</span><span class="p" data-group-id="0318870567-8">(</span><span class="p" data-group-id="0318870567-8">)</span><span class="p">,</span><span class="w"> </span><span class="ss">primary_key</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
        </span><span class="k">unquote_splicing</span><span class="p" data-group-id="0318870567-9">(</span><span class="n">exprs</span><span class="p" data-group-id="0318870567-9">)</span><span class="w">
      </span><span class="k" data-group-id="0318870567-7">end</span><span class="w">
    </span><span class="k" data-group-id="0318870567-5">end</span><span class="w">
  </span><span class="k" data-group-id="0318870567-4">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">create_feed_publish_table</span><span class="p" data-group-id="0318870567-10">(</span><span class="p" data-group-id="0318870567-10">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_feed_publish_table</span><span class="p" data-group-id="0318870567-11">(</span><span class="p" data-group-id="0318870567-12">[</span><span class="p" data-group-id="0318870567-12">]</span><span class="p" data-group-id="0318870567-11">)</span><span class="w">
  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">create_feed_publish_table</span><span class="p" data-group-id="0318870567-13">(</span><span class="p" data-group-id="0318870567-14">[</span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0318870567-15">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="0318870567-15">}</span><span class="p" data-group-id="0318870567-14">]</span><span class="p" data-group-id="0318870567-13">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">make_feed_publish_table</span><span class="p" data-group-id="0318870567-16">(</span><span class="n">body</span><span class="p" data-group-id="0318870567-16">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">drop_feed_publish_table</span><span class="p" data-group-id="0318870567-17">(</span><span class="p" data-group-id="0318870567-17">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">drop_pointable_table</span><span class="p" data-group-id="0318870567-18">(</span><span class="nc">FeedPublish</span><span class="p" data-group-id="0318870567-18">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_feed_publish_feed_index</span><span class="p" data-group-id="0318870567-19">(</span><span class="n">dir</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="n">direction</span><span class="p" data-group-id="0318870567-20">(</span><span class="p" data-group-id="0318870567-20">)</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="0318870567-21">[</span><span class="p" data-group-id="0318870567-21">]</span><span class="p" data-group-id="0318870567-19">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_feed_publish_feed_index</span><span class="p" data-group-id="0318870567-22">(</span><span class="ss">:up</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="0318870567-22">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">create_if_not_exists</span><span class="p" data-group-id="0318870567-23">(</span><span class="n">index</span><span class="p" data-group-id="0318870567-24">(</span><span class="na">@feed_publish_table</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0318870567-25">[</span><span class="ss">:feed_id</span><span class="p" data-group-id="0318870567-25">]</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="0318870567-24">)</span><span class="p" data-group-id="0318870567-23">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">migrate_feed_publish_feed_index</span><span class="p" data-group-id="0318870567-26">(</span><span class="ss">:down</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="0318870567-26">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">drop_if_exists</span><span class="p" data-group-id="0318870567-27">(</span><span class="n">index</span><span class="p" data-group-id="0318870567-28">(</span><span class="na">@feed_publish_table</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0318870567-29">[</span><span class="ss">:feed_id</span><span class="p" data-group-id="0318870567-29">]</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="0318870567-28">)</span><span class="p" data-group-id="0318870567-27">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">mf</span><span class="p" data-group-id="0318870567-30">(</span><span class="ss">:up</span><span class="p" data-group-id="0318870567-30">)</span><span class="w"> </span><span class="k" data-group-id="0318870567-31">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="0318870567-32">do</span><span class="w">
      </span><span class="nc">Bonfire.Data.Social.FeedPublish.Migration</span><span class="o">.</span><span class="n">create_feed_publish_table</span><span class="p" data-group-id="0318870567-33">(</span><span class="p" data-group-id="0318870567-33">)</span><span class="w">
      </span><span class="nc">Bonfire.Data.Social.FeedPublish.Migration</span><span class="o">.</span><span class="n">migrate_feed_publish_feed_index</span><span class="p" data-group-id="0318870567-34">(</span><span class="p" data-group-id="0318870567-34">)</span><span class="w">
    </span><span class="k" data-group-id="0318870567-32">end</span><span class="w">
  </span><span class="k" data-group-id="0318870567-31">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">mf</span><span class="p" data-group-id="0318870567-35">(</span><span class="ss">:down</span><span class="p" data-group-id="0318870567-35">)</span><span class="w"> </span><span class="k" data-group-id="0318870567-36">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="0318870567-37">do</span><span class="w">
      </span><span class="nc">Bonfire.Data.Social.FeedPublish.Migration</span><span class="o">.</span><span class="n">migrate_feed_publish_feed_index</span><span class="p" data-group-id="0318870567-38">(</span><span class="p" data-group-id="0318870567-38">)</span><span class="w">
      </span><span class="nc">Bonfire.Data.Social.FeedPublish.Migration</span><span class="o">.</span><span class="n">drop_feed_publish_table</span><span class="p" data-group-id="0318870567-39">(</span><span class="p" data-group-id="0318870567-39">)</span><span class="w">
    </span><span class="k" data-group-id="0318870567-37">end</span><span class="w">
  </span><span class="k" data-group-id="0318870567-36">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">migrate_feed_publish</span><span class="p" data-group-id="0318870567-40">(</span><span class="p" data-group-id="0318870567-40">)</span><span class="w"> </span><span class="k" data-group-id="0318870567-41">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="0318870567-42">do</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="o">.</span><span class="n">direction</span><span class="p" data-group-id="0318870567-43">(</span><span class="p" data-group-id="0318870567-43">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:up</span><span class="p">,</span><span class="w">
        </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="0318870567-44">(</span><span class="n">mf</span><span class="p" data-group-id="0318870567-45">(</span><span class="ss">:up</span><span class="p" data-group-id="0318870567-45">)</span><span class="p" data-group-id="0318870567-44">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="0318870567-46">(</span><span class="n">mf</span><span class="p" data-group-id="0318870567-47">(</span><span class="ss">:down</span><span class="p" data-group-id="0318870567-47">)</span><span class="p" data-group-id="0318870567-46">)</span><span class="w">
    </span><span class="k" data-group-id="0318870567-42">end</span><span class="w">
  </span><span class="k" data-group-id="0318870567-41">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">migrate_feed_publish</span><span class="p" data-group-id="0318870567-48">(</span><span class="n">dir</span><span class="p" data-group-id="0318870567-48">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">mf</span><span class="p" data-group-id="0318870567-49">(</span><span class="n">dir</span><span class="p" data-group-id="0318870567-49">)</span><span class="w">

</span><span class="k" data-group-id="0318870567-1">end</span></code></pre><h3 id="module-more-examples" class="section-heading"><a href="#module-more-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">More examples</span></h3><p>Take a look at a few of the migrations in our data libraries. Between them, they cover most
scenarios by now:</p><ul><li><a href="https://github.com/bonfire-networks/bonfire_data_social/">bonfire_data_social</a></li><li><a href="https://github.com/bonfire-networks/bonfire_data_access_control/">bonfire_data_access_control</a></li><li><a href="https://github.com/bonfire-networks/bonfire_data_identity/">bonfire_data_identity</a></li><li><a href="https://github.com/bonfire-networks/bonfire_data_edges/">bonfire_data_edges</a> (feat. bonus triggers)</li></ul><p>If you want to know exactly what's happening, you may want to read the code for
<a href="https://github.com/bonfire-networks/needle/blob/main/lib/migration.ex">Needle.Migration</a>.</p><h2 id="module-configuration-and-overrides" class="section-heading"><a href="#module-configuration-and-overrides" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration and overrides</span></h2><p>Every pointable or mixin schema is overrideable with configuration
during compilation (this is why using them requires an <code class="inline">:otp_app</code> to
be specified). For example, we could override <a href="./Needle.Table.html"><code class="inline">Needle.Table</code></a> (which
is a pointable table) thus:</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:needle</span><span class="p">,</span><span class="w"> </span><span class="nc">Needle.Table</span><span class="p">,</span><span class="w"> </span><span class="ss">source</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my_pointers_table&quot;</span></code></pre><p>The <code class="inline">table_id</code> is also configurable, but we don't recommend you change it.</p><p>In addition, all pointable and mixin schemas permit extension with <a href="https://github.com/bonfire-networks/exto">Exto</a>. See the <a href="./Exto.html"><code class="inline">Exto</code></a>'s docs for more information about how to extend schemas via configuration. You will probably at the very least want to insert some <code class="inline">has_one</code> for mixins off your pointables.</p><h2 id="module-referencing-pointables" class="section-heading"><a href="#module-referencing-pointables" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Referencing Pointables</span></h2><p>Ecto does not know anything about our scheme, so unless we specifically want something to reference one of the pointed tables, we typically <code class="inline">belongs_to</code> with <a href="./Needle.Pointer.html"><code class="inline">Needle.Pointer</code></a>. The table in which we do this does not itself need to necessarily be a <code class="inline">Pointable</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Foo</span><span class="w"> </span><span class="k" data-group-id="3313798372-1">do</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Schema</span><span class="w">

  </span><span class="c1"># regular ecto table, not pointable!</span><span class="w">
  </span><span class="n">schema</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="k" data-group-id="3313798372-2">do</span><span class="w">
    </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:pointer</span><span class="p">,</span><span class="w"> </span><span class="nc">Needle.Pointer</span><span class="w"> </span><span class="c1"># who knows what it points to?</span><span class="w">
  </span><span class="k" data-group-id="3313798372-2">end</span><span class="w">
</span><span class="k" data-group-id="3313798372-1">end</span></code></pre><p>You may choose to reference a specific schema rather than Pointer if it
will only point to a single table. If you do this, you must ensure
that the referenced record exists in that table in the normal
way. There may be some performance benefit, we didn't benchmark it.</p><p>The migration is slightly more complex, we have to decide what type of
a pointer it is. Needle come in three categories:</p><ul><li>A strong pointer is not nullable and is deleted when the object it
points to is deleted.</li><li>A weak pointer is nullable and is nilified when the object it points
to is deleted.</li><li>An unbreakable pointer will raise when you attempt to delete the
object it points to.</li></ul><table><thead><tr><th style="text-align: left;">Type</th><th style="text-align: left;">Nullable?</th><th style="text-align: left;">On Delete</th></tr></thead><tbody><tr><td style="text-align: left;">Strong</td><td style="text-align: left;">No</td><td style="text-align: left;">Cascade</td></tr><tr><td style="text-align: left;">Weak</td><td style="text-align: left;">Yes</td><td style="text-align: left;">Set Null</td></tr><tr><td style="text-align: left;">Unbreakable</td><td style="text-align: left;">No</td><td style="text-align: left;">Raise</td></tr></tbody></table><p>In this case we will use a strong pointer, because we want it to be
deleted if the pointed object is deleted.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Repo.Migrations.Hello</span><span class="w"> </span><span class="k" data-group-id="7524429544-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ecto.Migration</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Needle.Migration</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">change</span><span class="p" data-group-id="7524429544-2">(</span><span class="p" data-group-id="7524429544-2">)</span><span class="w"> </span><span class="k" data-group-id="7524429544-3">do</span><span class="w">
    </span><span class="n">create_if_not_exists</span><span class="w"> </span><span class="n">table</span><span class="p" data-group-id="7524429544-4">(</span><span class="ss">:hello</span><span class="p" data-group-id="7524429544-4">)</span><span class="w"> </span><span class="k" data-group-id="7524429544-5">do</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:pointer</span><span class="p">,</span><span class="w"> </span><span class="n">strong_pointer</span><span class="p" data-group-id="7524429544-6">(</span><span class="p" data-group-id="7524429544-6">)</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">add</span><span class="w"> </span><span class="ss">:greeting</span><span class="p">,</span><span class="w"> </span><span class="ss">:text</span><span class="p">,</span><span class="w"> </span><span class="ss">null</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="7524429544-5">end</span><span class="w">
  </span><span class="k" data-group-id="7524429544-3">end</span><span class="w">
</span><span class="k" data-group-id="7524429544-1">end</span></code></pre><p>If you are pointing to a specific table instead of pointer,
<code class="inline">strong_pointer/1</code> allows you to pass the name of that module
(<code class="inline">strong_pointer/0</code> calls this with <a href="./Needle.Pointer.html"><code class="inline">Needle.Pointer</code></a>).</p><h2 id="module-dereferencing-pointables" class="section-heading"><a href="#module-dereferencing-pointables" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Dereferencing Pointables</span></h2><p>It is common that even though you have a universal foreign key, you
will want to issue different queries based upon the type that is being
pointed to. For this reason, it is up to you to decide how to perform
an onward query.</p><p><a href="./Needle.Pointers.html#schema/1"><code class="inline">Needle.Pointers.schema/1</code></a> turns a <code class="inline">Pointer</code> into an Ecto schema module name
you can switch against. <code class="inline">Needle.Pointers.plan</code> breaks down a list of Needle
into a map of ids keyed by schema module. It is handy to define some
functions in your (non-library) application that can load any type of
pointer in given contexts.</p><h2 id="module-inserting-data" class="section-heading"><a href="#module-inserting-data" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Inserting data</span></h2><h3 id="module-elixir-based-logic" class="section-heading"><a href="#module-elixir-based-logic" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Elixir-based logic</span></h3><p>The practical result of needle is that it pushes a certain amount of
validation and consistency logic back into elixir land. It is
therefore your elixir code's responsibility to ensure that data is
inserted into the appropriate mixin tables when inserting a pointable
object and to manage deletions as appropriate.</p><p>When assembling queries with mixin tables, pay careful attention to
the type of join you are performing. An inner join is explicitly
asking not to be shown objects that do not have a record for that
mixin. You quite possibly wanted to left join.</p><h2 id="module-querying-needle" class="section-heading"><a href="#module-querying-needle" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Querying Needle</span></h2><p>Since <code class="inline">Pointer</code> has a table, you can use its <code class="inline">table_id</code> field to
filter by pointed type. <a href="./Needle.Tables.html#id!/1"><code class="inline">Needle.Tables.id!/1</code></a> (or <code class="inline">ids!/1</code> for a
list) can be used to obtain the IDs for a table or tables.</p><h2 id="module-tradeoffs" class="section-heading"><a href="#module-tradeoffs" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tradeoffs</span></h2><p>All solutions to the universal primary key problem have tradeofs. Here
are what we see as the deficiencies in our approach:</p><ol><li>It forces a UUIDv7 or ULID on you. This is great for us, but not
everyone. They both expose a timestamp with millisecond precision. 
If the time of creation of a resource is sensitive information for
your purposes, they may not going to be suitable for you.</li><li>Ecto has no knowledge of the specialty of <code class="inline">Pointer</code>,
e.g. <code class="inline">Repo.preload</code> does not work and you need to specify a join
condition to join through a pointer. Use our functions or add extra
associations with exto configuration.</li><li>Dereferencing a list of needle requires a select query per table
type that occurs in the input set.</li><li>Reliance on user attention. You have to follow the instructions
correctly to make the system work at all.</li><li>There is likely some performance impact from postgres not
understanding the relationships between the various tables
properly. It's hard to gauge and we haven't even tried.</li></ol><p>These are not likely to change. If you're going to pick
this library, do so in the full knowledge of the tradeoffs it makes.</p><p>Alternatives include (I'm sure you can think of others):</p><ul><li>Storing the table name in a second column alongside every foreign key.</li><li>A compound datatype of id and table name.</li><li>Byte/String manipulation tricks.</li><li>Evil SQL hacks based upon compile time configuration.</li></ul><p>While we have our gripes with this approach, once you've gotten the
hang of using it, it works out pretty well for most purposes and it's
one of the simpler options to work with.</p><h2 id="module-copyright-and-license" class="section-heading"><a href="#module-copyright-and-license" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Copyright and License</span></h2><p>Copyright (c) 2020 needle Contributors</p><p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p><p>   <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p><p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#is_needle?/2" data-no-tooltip="" translate="no">is_needle?(schema_or_struct, one_of_types \\ [:pointable, :virtual, :mixin, :unpointable, :random, :form])</a>

      </div>

    </div>

</div>

  </section>


  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>
    <div class="functions-list">
<section class="detail" id="is_needle?/2">

    <span id="is_needle?/1"></span>

  <div class="detail-header">
    <a href="#is_needle?/2" class="detail-link" data-no-tooltip="" aria-label="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
    </a>
    <div class="heading-with-actions">
      <h1 class="signature" translate="no">is_needle?(schema_or_struct, one_of_types \\ [:pointable, :virtual, :mixin, :unpointable, :random, :form])</h1>


        <a href="https://github.com/bonfire-networks/needle/blob/main/lib/needle.ex#L4" class="icon-action" rel="help" aria-label="View Source">
          <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        </a>

    </div>
  </div>

  <section class="docstring">


  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Bonfire.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
