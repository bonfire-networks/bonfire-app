<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="Bonfire v0.9.10-classic-beta.132">


    <title>ActivityPub.MRF â€” Bonfire v0.9.10-classic-beta.132</title>
    <link rel="stylesheet" href="dist/html-elixir-F2VRIOKR.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-28F3E564.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-YIPIRHGU.js"></script>

  </head>
  <body data-type="modules" class="page-behaviour">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://bonfirenetworks.org" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Bonfire" />
        </a>

      <div>
        <a href="https://bonfirenetworks.org" class="sidebar-projectName" translate="no">
Bonfire
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.9.10-classic-beta.132
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


        <li>
          <button id="tasks-list-tab-button" role="tab" data-type="tasks" aria-controls="tasks-tab-panel" aria-selected="false" tabindex="-1">
            <span translate="no">Mix</span> Tasks
          </button>
        </li>

    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


    <div id="tasks-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="tasks-list-tab-button" hidden>
      <ul id="tasks-full-list" class="full-list"></ul>
    </div>

</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Bonfire</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

    <span translate="no">ActivityPub.MRF</span> <small>behaviour</small>
    <small class="app-vsn" translate="no">(Bonfire v0.9.10-classic-beta.132)</small>

  </h1>


    <section id="moduledoc">
<p>Message Rewrite Facility</p><p><strong>WARNING: Due to how this app currently handles its configuration, MRF is only usable if you're building your own docker image.</strong></p><p>The Message Rewrite Facility (MRF) is a subsystem that is implemented as a series of hooks that allows the administrator to rewrite or discard messages.</p><p>Possible uses include:</p><ul><li>marking incoming messages with media from a given account or instance as sensitive</li><li>rejecting messages from a specific instance</li><li>rejecting reports (flags) from a specific instance</li><li>removing/unlisting messages from the public timelines</li><li>removing media from messages</li><li>sending only public messages to a specific instance</li></ul><p>The MRF provides user-configurable policies. The default policy is <code class="inline">NoOpPolicy</code>, which disables the MRF functionality. Bonfire also includes an easy to use policy called <code class="inline">SimplePolicy</code> which maps messages matching certain pre-defined criterion to actions built into the policy module. It is possible to use multiple, active MRF policies at the same time.</p><blockquote><p>See the docs of <a href="./ActivityPub.MRF.SimplePolicy.html"><code class="inline">ActivityPub.MRF.SimplePolicy</code></a> for details about how to use it.</p></blockquote><h3 id="module-use-with-care" class="section-heading">
  <a href="#module-use-with-care" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Use with Care</span>
</h3>
<p>The effects of MRF policies can be very drastic. It is important to use this functionality carefully. Always try to talk to an admin before writing an MRF policy concerning their instance.</p><h2 id="module-writing-your-own-mrf-policy" class="section-heading">
  <a href="#module-writing-your-own-mrf-policy" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Writing your own MRF Policy</span>
</h2>
<p>As discussed above, the MRF system is a modular system that supports pluggable policies. This means that an admin may write a custom MRF policy in Elixir or any other language that runs on the Erlang VM, by specifying the module name in the <code class="inline">rewrite_policy</code> config setting.</p><p>For example, here is a sample policy module which rewrites all messages to &quot;new message content&quot;:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># This is a sample MRF policy which rewrites all Notes to have &quot;new message</span><span class="w">
</span><span class="c1"># content.&quot;</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Site.RewritePolicy</span><span class="w"> </span><span class="k" data-group-id="4975903093-1">do</span><span class="w">
  </span><span class="na">@behavior</span><span class="w"> </span><span class="nc">ActivityPub.MRF</span><span class="w">

  </span><span class="c1"># Catch messages which contain Note objects with actual data to filter.</span><span class="w">
  </span><span class="c1"># Capture the object as `object`, the message content as `content` and the</span><span class="w">
  </span><span class="c1"># entire activity itself as `activity`.</span><span class="w">
  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">filter</span><span class="p" data-group-id="4975903093-2">(</span><span class="p" data-group-id="4975903093-3">%{</span><span class="s">&quot;type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;Create&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;object&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4975903093-4">%{</span><span class="s">&quot;type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;Note&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;content&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">content</span><span class="p" data-group-id="4975903093-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object</span><span class="p" data-group-id="4975903093-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="4975903093-2">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="4975903093-5">(</span><span class="n">content</span><span class="p" data-group-id="4975903093-5">)</span><span class="w"> </span><span class="k" data-group-id="4975903093-6">do</span><span class="w">
    </span><span class="c1"># Subject / CW is stored as summary instead of `name` like other AS2 objects</span><span class="w">
    </span><span class="c1"># because of Mastodon doing it that way.</span><span class="w">
    </span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object</span><span class="p" data-group-id="4975903093-7">[</span><span class="s">&quot;summary&quot;</span><span class="p" data-group-id="4975903093-7">]</span><span class="w">

    </span><span class="c1"># edits go here.</span><span class="w">
    </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;new message content&quot;</span><span class="w">

    </span><span class="c1"># Assemble the mutated object.</span><span class="w">
    </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">object</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="4975903093-8">(</span><span class="s">&quot;content&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p" data-group-id="4975903093-8">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="4975903093-9">(</span><span class="s">&quot;summary&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">summary</span><span class="p" data-group-id="4975903093-9">)</span><span class="w">

    </span><span class="c1"># Assemble the mutated activity.</span><span class="w">
    </span><span class="p" data-group-id="4975903093-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="4975903093-11">(</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;object&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p" data-group-id="4975903093-11">)</span><span class="p" data-group-id="4975903093-10">}</span><span class="w">
  </span><span class="k" data-group-id="4975903093-6">end</span><span class="w">

  </span><span class="c1"># Let all other messages through without modifying them.</span><span class="w">
  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">filter</span><span class="p" data-group-id="4975903093-12">(</span><span class="n">message</span><span class="p" data-group-id="4975903093-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4975903093-13">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="4975903093-13">}</span><span class="w">
</span><span class="k" data-group-id="4975903093-1">end</span></code></pre><p>If you save this file as <code class="inline">lib/site/mrf/rewrite_policy.ex</code>, it will be included when you next rebuild Bonfire. You can enable it in the configuration like so:</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:activity_pub</span><span class="p">,</span><span class="w"> </span><span class="ss">:instance</span><span class="p">,</span><span class="w">
  </span><span class="ss">rewrite_policy</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9334792589-1">[</span><span class="w">
    </span><span class="nc">ActivityPub.MRF.SimplePolicy</span><span class="p">,</span><span class="w">
    </span><span class="nc">Site.RewritePolicy</span><span class="w">
  </span><span class="p" data-group-id="9334792589-1">]</span></code></pre>
    </section>

</div>

  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-callbacks summary">
  <h2>
    <a href="#callbacks">Callbacks</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:filter/2" data-no-tooltip translate="no">filter(t, boolean)</a>

      </div>

    </div>

</div>
<div class="summary-functions summary">
  <h2>
    <a href="#functions">Functions</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#filter/2" data-no-tooltip translate="no">filter(object, is_local?)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#filter/3" data-no-tooltip translate="no">filter(policies, object, is_local?)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#get_policies/0" data-no-tooltip translate="no">get_policies()</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#subdomain_match?/2" data-no-tooltip translate="no">subdomain_match?(domains, host)</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#subdomains_regex/1" data-no-tooltip translate="no">subdomains_regex(domains)</a>

      </div>

    </div>

</div>

  </section>


  <section id="callbacks" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#callbacks">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Callbacks</span>
    </h1>
    <div class="callbacks-list">
<section class="detail" id="c:filter/2">

  <div class="detail-header">
    <a href="#c:filter/2" class="detail-link" data-no-tooltip title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">filter(t, boolean)</h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L81" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> filter(Map.t(), <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">boolean</a>()) :: {:ok | :reject, Map.t()}</pre>

      </div>


  </section>
</section>

    </div>
  </section>

  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Functions</span>
    </h1>
    <div class="functions-list">
<section class="detail" id="filter/2">

  <div class="detail-header">
    <a href="#filter/2" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">filter(object, is_local?)</h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L94" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="filter/3">

  <div class="detail-header">
    <a href="#filter/3" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">filter(policies, object, is_local?)</h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L83" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="get_policies/0">

  <div class="detail-header">
    <a href="#get_policies/0" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">get_policies()</h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L97" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="subdomain_match?/2">

  <div class="detail-header">
    <a href="#subdomain_match?/2" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">subdomain_match?(domains, host)</h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L126" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> subdomain_match?([<a href="https://hexdocs.pm/elixir/Regex.html#t:t/0">Regex.t</a>()], <a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()) :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">boolean</a>()</pre>

      </div>


  </section>
</section>
<section class="detail" id="subdomains_regex/1">

  <div class="detail-header">
    <a href="#subdomains_regex/1" class="detail-link" data-no-tooltip title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">subdomains_regex(domains)</h1>

      <a href="https://github.com/bonfire-networks/activity_pub/blob/main/lib/safety/mrf.ex#L111" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@spec</span> subdomains_regex([<a href="https://hexdocs.pm/elixir/String.html#t:t/0">String.t</a>()]) :: [<a href="https://hexdocs.pm/elixir/Regex.html#t:t/0">Regex.t</a>()]</pre>

      </div>


  </section>
</section>

    </div>
  </section>

    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="Bonfire.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
